{% extends "base/SuperAdmin.html" %}

{% block content %}

<style>
    .step-box {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        justify-content: center;
        align-items: center;
        font-weight: bold;
    }
    .step-active {
        background-color: #6366f1;
        color: white;
    }
    .step-inactive {
        background-color: #eee;
        color: #666;
    }
    .step-label {
        font-size: 0.9rem;
    }
    .step-subtext {
        font-size: 0.75rem;
        color: #999;
    }
    .entry-group .btn-close {
        font-size: 0.9rem;
        background-color: #f8d7da;
        border-radius: 50%;
    }
    .entry-group .btn-close:hover {
        background-color: #f5c2c7;
    }
</style>



{% if active_period %}
<div class="d-flex justify-content-center mb-4">
    <div class="card shadow-none bg-transparent border border-primary text-primary w-50">
        <div class="card-body text-center py-3">
            <h4 class="mb-3 text-primary fw-bold">Evaluation Period</h4>
            <p class="fs-5 mb-1 fw-semibold">{{ active_period.name }}</p>
            <p class="text-muted fs-6">
                {{ active_period.start_date.strftime('%B %d, %Y') }} – {{ active_period.end_date.strftime('%B %d, %Y') }}
            </p>
        </div>
    </div>
</div>
{% endif %}

<div class="container p-0">
    <!-- Step Indicators -->
    <div class="d-flex align-items-center gap-4 mb-4" id="step-indicators">
        <!-- Will be generated by JS -->
    </div>

    <!-- Wizard Steps -->
    <div id="wizard-steps">
        <!-- Step 1: Core Function -->
        <div class="card p-4 step" id="step-1">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" onclick="addEntry(1)">Add Entry</button>
            </div>
            <div id="entry-container-1">
                <div class="card p-4 mb-4 entry-group position-relative border border-primary-subtle">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">MFO (Major Final Output)</label>
                            <input type="text" class="form-control" placeholder="Enter major final output">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Success Indicators (Targets + Measures)</label>
                            <textarea class="form-control" rows="1" placeholder="Enter targets and measures"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Allocated Budget</label>
                            <input type="text" class="form-control" placeholder="Purchased items or funded activities">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Actual Accomplishments / Expenses</label>
                            <input type="text" class="form-control" placeholder="Completed tasks or amount spent">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 d-flex justify-content-between">
                <button class="btn btn-outline-secondary" disabled>Back</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
            </div>
        </div>

        <!-- Step 2: Social Functions -->
        <div class="card p-4 step d-none" id="step-2">
            <div class="d-flex justify-content-end mb-3">
                <button class="btn btn-primary" onclick="addEntry(2)">Add Entry</button>
            </div>
            <div id="entry-container-2">
                <div class="card p-4 mb-4 entry-group position-relative border border-primary-subtle">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">MFO (Major Final Output)</label>
                            <input type="text" class="form-control" placeholder="Enter major final output">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Success Indicators (Targets + Measures)</label>
                            <textarea class="form-control" rows="1" placeholder="Enter targets and measures"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Allocated Budget</label>
                            <input type="text" class="form-control" placeholder="Purchased items or funded activities">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-bold">Actual Accomplishments / Expenses</label>
                            <input type="text" class="form-control" placeholder="Completed tasks or amount spent">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 d-flex justify-content-between">
                <button class="btn btn-outline-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-primary" onclick="nextStep()">Next</button>
            </div>
        </div>

        <!-- Step 3: Summary -->
        <div class="card p-4 step d-none" id="step-3">
            <h5>Summary</h5>
            <div id="entry-container-submit" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th rowspan="2">MFO</th>
                                <th rowspan="2">Success Indicator</th>
                                <th rowspan="2">Allocated Budget</th>
                                <th rowspan="2">Individual Accountable</th>
                                <th rowspan="2">Actual Accomplishments </th>
                                <th colspan="4">RATING</th>
                                <th rowspan="2">Remarks</th>
                            </tr>
                            <tr>
                                <th>Q</th>
                                <th>E</th>
                                <th>T</th>
                                <th>A</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-primary fw-semibold">
                                <td colspan="10" class="text-start">Core Functions</td>
                            </tr>
                        </tbody>
                        <tbody id="core-entries"></tbody>

                        <tbody>
                            <tr class="table-primary fw-semibold">
                                <td colspan="10" class="text-start">Support Functions</td>
                            </tr>
                        </tbody>
                        <tbody id="support-entries"></tbody>
                    </table>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-3">
                <button class="btn btn-outline-secondary" onclick="prevStep()">Back</button>
                <button class="btn btn-success" onclick="finishWizard()">Finish</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal For Refill -->
<div class="modal fade" id="prefillConfirmModal" tabindex="-1" aria-labelledby="prefillConfirmLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary">
      <div class="modal-header">
        <h5 class="modal-title" id="prefillConfirmLabel">Prefill IPCR Data</h5>
      </div>
      <div class="modal-body">
        Previous IPCR data was found. Would you like to prefill the form with this data?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="decline-prefill-btn">No, Start Fresh</button>
        <button type="button" class="btn btn-primary" id="confirm-prefill-btn">Yes, Prefill</button>
      </div>
    </div>
  </div>
</div>



<script id="prefill-json" type="application/json">
  {{ prefill_data | tojson | safe }}
</script>

<script id="force-prefill-json" type="application/json">
  {{ force_prefill | tojson | safe }}
</script>

<script>
    const departmentName = "{{ full_name }}";
    const prefillData = JSON.parse(document.getElementById('prefill-json').textContent);
    const forcePrefill = JSON.parse(document.getElementById('force-prefill-json').textContent);

    let currentStep = 1;
    const totalSteps = 3;

    document.addEventListener("DOMContentLoaded", () => {
    updateSteps();

    // Only proceed if there's data to prefill
    if (prefillData && prefillData.length > 0) {
        const modalElement = document.getElementById('prefillConfirmModal');
        const modal = new bootstrap.Modal(modalElement);

        if (forcePrefill) {
            injectPrefillData(prefillData); // Auto-prefill
        } else {
            // Show modal to ask the user
            modal.show();

            const confirmBtn = document.getElementById('confirm-prefill-btn');
            const declineBtn = document.getElementById('decline-prefill-btn');

            // Prevent duplicate listeners by removing any existing ones
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            declineBtn.replaceWith(declineBtn.cloneNode(true));

            document.getElementById('confirm-prefill-btn').addEventListener('click', () => {
                injectPrefillData(prefillData);
                modal.hide();
            });

            document.getElementById('decline-prefill-btn').addEventListener('click', () => {
                modal.hide();
            });
        }
    }
});

    function updateSteps() {
        for (let i = 1; i <= totalSteps; i++) {
            document.getElementById(`step-${i}`).classList.toggle('d-none', i !== currentStep);
        }

        const titles = ['Core Function', 'Support Functions', 'Summary'];
        const subs = ['List main operational roles', 'Describe community contributions', 'Review and finalize entries'];

        document.getElementById('step-indicators').innerHTML = titles.map((title, i) => {
            const active = currentStep === i + 1 ? 'step-active' : 'step-inactive';
            return `
                <div class="d-flex align-items-center gap-2">
                    <div class="step-box ${active}">${i + 1}</div>
                    <div>
                        <div class="step-label">${title}</div>
                        <div class="step-subtext">${subs[i]}</div>
                    </div>
                </div>
                ${i + 1 < totalSteps ? '<span class="text-muted fs-4">›</span>' : ''}
            `;
        }).join('');
    }

    function nextStep() {
        if (currentStep < totalSteps) {
            currentStep++;
            updateSteps();

            if (currentStep === 3) {
                document.getElementById('entry-container-submit').style.display = 'block';
                fillSummaryTable();
            }
        }
    }

    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateSteps();
        }
    }

    function finishWizard() {
    const groupedSections = {
        Core: [],
        Support: []
    };

    [1, 2].forEach(step => {
        const entries = document.querySelectorAll(`#entry-container-${step} .entry-group`);
        entries.forEach(entry => {
            const inputs = entry.querySelectorAll('input, textarea');
            const sectionType = step === 1 ? 'Core' : 'Support';
            groupedSections[sectionType].push({
                mfo: inputs[0].value.trim(),
                success_indicator: inputs[1].value.trim(),
                allotted_budget: inputs[2].value.trim(),
                accomplishment: inputs[3].value.trim()
            });
        });
    });

    const sections = Object.entries(groupedSections).map(([type, items]) => ({
        type,
        items
    }));

    fetch('/submit-ipcrHR', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sections })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'An unexpected error occurred.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.redirect) {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'IPCR submitted successfully.',
                timer: 2000,
                showConfirmButton: false
            }).then(() => {
                window.location.href = data.redirect;
            });
        }
    })
    .catch(err => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: err.message || 'Something went wrong submitting the IPCR.'
        });
    });
}



    function addEntry(stepNumber) {
        const container = document.getElementById(`entry-container-${stepNumber}`);
        if (!container) return;

        const entry = document.createElement('div');
        entry.className = 'card p-4 mb-4 entry-group position-relative border border-primary-subtle';

        entry.innerHTML = `
        <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 mt-3" onclick="this.closest('.entry-group').remove()">
            Remove
        </button>
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label fw-bold">MFO (Major Final Output)</label>
                <input type="text" class="form-control" placeholder="e.g. Deliver Health Services">
                <small class="text-muted">Specify the major output under your function.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Success Indicators (Targets + Measures)</label>
                <textarea class="form-control" rows="2" placeholder="e.g. 95% vaccination coverage"></textarea>
                <small class="text-muted">Indicate measurable targets and standards.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Allocated Budget</label>
                <input type="text" class="form-control" placeholder="e.g. ₱200,000">
                <small class="text-muted">List the budgeted amount or item support.</small>
            </div>
            <div class="col-md-6">
                <label class="form-label fw-bold">Actual Accomplishments / Expenses</label>
                <input type="text" class="form-control" placeholder="e.g. ₱180,000 spent on medical supplies">
                <small class="text-muted">State actual outputs or costs incurred.</small>
            </div>
        </div>
        `;

        container.appendChild(entry);
    }

    function fillSummaryTable() {
        const stepMap = {
            1: 'core-entries',
            2: 'support-entries'
        };

        Object.entries(stepMap).forEach(([stepNum, targetId]) => {
            const rowContainer = document.getElementById(targetId);
            const entries = document.querySelectorAll(`#entry-container-${stepNum} .entry-group`);
            rowContainer.innerHTML = '';

            entries.forEach(entry => {
                const fields = Array.from(entry.querySelectorAll('input, textarea')).map(e => e.value.trim());
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${fields[0]}</td>
                    <td>${fields[1]}</td>
                    <td>${fields[2]}</td>
                    <td>${departmentName}</td>
                    <td>${fields[3]}</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>`;
                rowContainer.appendChild(tr);
            });
        });
    }


    function injectPrefillData(data) {

        
    // Clear existing entries
    document.getElementById('entry-container-1').innerHTML = '';
    document.getElementById('entry-container-2').innerHTML = '';

    data.forEach(entry => {
        const step = entry.type === 'Core' ? 1 : 2;



        const container = document.getElementById(`entry-container-${step}`);
        const newEntry = document.createElement('div');
        newEntry.className = 'card p-4 mb-4 entry-group position-relative border border-primary-subtle';

        newEntry.innerHTML = `
            <button type="button" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-2 mt-3"
                onclick="this.closest('.entry-group').remove()">Remove</button>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label fw-bold">MFO (Major Final Output)</label>
                    <input type="text" class="form-control" value="${entry.mfo}" placeholder="e.g. Deliver Health Services">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Success Indicators (Targets + Measures)</label>
                    <textarea class="form-control" rows="2" placeholder="e.g. 95% vaccination coverage">${entry.success_indicator}</textarea>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Allocated Budget</label>
                    <input type="text" class="form-control" value="${entry.allotted_budget}" placeholder="e.g. ₱200,000">
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-bold">Actual Accomplishments / Expenses</label>
                    <input type="text" class="form-control" value="${entry.accomplishment}" placeholder="e.g. ₱180,000 spent on medical supplies">
                </div>
            </div>
        `;

        container.appendChild(newEntry);
    });
}

</script>

{% endblock content %}
