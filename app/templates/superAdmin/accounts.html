{% extends "base/SuperAdmin.html" %}
{% block content %}



<div class="col-xl-12">

  <div class="nav-align-top mb-4">
     <ul class="nav nav-pills mb-3 flex-nowrap overflow-auto" role="tablist" style="white-space: nowrap;">


        <li class="nav-item">
          <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                  data-bs-target="#navs-pills-travel-order" id="travel-order-tab" 
                  aria-controls="navs-pills-travel-order" aria-selected="true">
                  Permanent, Co-Term and Electives
          </button>
        </li>

        <li class="nav-item">
          <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                  data-bs-target="#navs-pills-Leave-Credits" id="Leave-Credits-tab" 
                  aria-controls="navs-pills-Leave-Credits" aria-selected="false">
                  Casual appointments
          </button>
        </li>
    
      

        <li class="nav-item">
          <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                  data-bs-target="#navs-pills-JO" id="JO-tab" 
                  aria-controls="navs-pills-JO" aria-selected="false">
                  Job Order
          </button>
        </li>
    
     
      </ul>
    
      <div class="tab-content h-100 min-vh-100">

        <!-- PERMANENT EMPLOYEE -->
        <div class="tab-pane fade show " id="navs-pills-travel-order" role="tabpanel" aria-labelledby="travel-order-tab">
          <div class="card-header border-bottom p-0 pb-4">
            <h5 class="card-title mb-0">Permanent Accounts</h5>

            <div class="row pt-4 g-3">
              <div class="col-12 col-md-6">
                <select id="permanentOrg" class="form-select text-capitalize">
                  <option value="">All Organizational Units</option>
                  {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                  {% endfor %}
                </select>
              </div>

              <div class="col-12 col-md-6">
                <select id="positionOrg" class="form-select text-capitalize">
                  <option value="">Select Position</option>
                </select>
              </div>
            </div>

          </div>
          <div class="card-datable">
            <div class="row mx-1 my-3 align-items-center justify-content-between">
              
              <!-- Left: Length selector -->
              <div class="col-12 col-md-auto mb-3 mb-md-0 ps-0">

              </div>
          
              <!-- Right: Search, Export, Add -->
          
            </div>
    
    
            <div class="dt-layout-table" style="height: 100%; display: flex; flex-direction: column;">
                <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
                  <table class="datatables-users table border-top dataTable dtr-column collapsed table-bordered" 
                      id="employeeTable" 
                      aria-describedby="DataTables_Table_0_info" 
                      style="width: 100%; height: 100%;">

                      <thead class="table-dark align-middle text-center">
                          <tr>
                              <th>ORGANIZATIONAL UNIT</th>
                              <th>POSITION TITLE</th>
                              <th>FULL NAME</th>
                              <th>EMAIL</th>
                              <th>LOGIN ID</th>
                              <th>ROLE</th>
                              <th>ACTION</th>
                          </tr>
                      </thead>

                      <tbody>
                          {% for emp in permanent_employees %}
                          <tr>
                              <td>
                                      {{ emp.department.name }}
                              </td>
                               <td>
                                {% if emp.permanent_details and emp.permanent_details.position %}
                                  {{ emp.permanent_details.position.title }}
                                {% else %}
                                  N/A
                                {% endif %}
                              </td>
                              <td>
                                  <a href="{{ url_for('EmployeeDetail', id=emp.id) }}" class="text-heading text-truncate fw-medium">
                                      {{ emp.last_name }} {{ emp.first_name }} {{ emp.middle_name }}
                                  </a>
                              </td>
                              <td>{{ emp.user.email }}</td>
                              <td>{{ emp.user.login_id }}</td>
                              <td>{{ emp.user.role }}</td>
                              <td class="text-center align-middle">
                                  <button type="button" class="btn btn-primary btn-edit"
                                      data-id="{{ emp.id }}"
                                      data-login-id="{{ emp.user.login_id }}"
                                      data-email="{{ emp.user.email }}"
                                      data-signature="{{ emp.user.signature_b64 or '' }}"
                                      data-role="{{ emp.user.role }}"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editEmployeeModal">
                                      Edit
                                  </button>
                              </td>
                          </tr>
                          {% endfor %}
                          {% if permanent_employees|length == 0 %}
                          <tr>
                              <td colspan="8" class="text-center">No employee records found.</td>
                          </tr>
                          {% endif %}
                      </tbody>
                  </table>

                </div>
        
            </div>
          </div>
        </div>

        <!-- CASUAL EMPLOYEE -->
        <div class="tab-pane fade " id="navs-pills-Leave-Credits" role="tabpanel" aria-labelledby="Leave-Credits-tab">

        <div class="card-header border-bottom p-0 pb-4">
          <h5 class="card-title mb-0">Casual Accounts</h5>
           
        </div>
        <div class="card-datable">
          <div class="row mx-1 my-3 align-items-center justify-content-between">
            
            <!-- Left: Length selector -->
            <div class="col-12 col-md-auto mb-3 mb-md-0 ps-0">
        
            </div>
        
        
          </div>
  
  
          <div class="dt-layout-table" style="height: 100%; display: flex; flex-direction: column;">
              <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
                     <table class="datatables-users table border-top dataTable dtr-column collapsed table-bordered" 
                      id="casualTable" 
                      aria-describedby="DataTables_Table_0_info" 
                      style="width: 100%; height: 100%;">

                      <thead class="table-dark align-middle text-center">
                          <tr>
                              <th>ORGANIZATIONAL UNIT</th>
                              <th>POSITION TITLE</th>
                              <th>FULL NAME</th>
                              <th>EMAIL</th>
                              <th>LOGIN ID</th>
                              <th>ROLE</th>
                              <th>STATUS</th>
                              <th>ACTION</th>
                          </tr>
                      </thead>

                      <tbody>
                          {% for emp in casual_employees %}
                          <tr>
                              <td>
                                  {{ emp.casual_details.assigned_department.name if emp.casual_details.assigned_department else 'No Department Assigned' }}
                              </td>
                              <td>
                                {% if emp.casual_details and emp.casual_details.position %}
                                  {{ emp.casual_details.position.title }}
                                {% else %}
                                  N/A
                                {% endif %}
                              </td>

                              <td>
                                  <a href="{{ url_for('EmployeeDetail', id=emp.id) }}" class="text-heading text-truncate fw-medium">
                                      {{ emp.last_name }} {{ emp.first_name }} {{ emp.middle_name }}
                                  </a>
                              </td>
                              <td>{{ emp.user.email }}</td>
                              <td>{{ emp.user.login_id }}</td>
                              <td>{{ emp.user.role }}</td>
                              <td>{{ emp.status }}</td>
                              <td class="text-center align-middle">
                                  <button type="button" class="btn btn-primary btn-edit"
                                      data-id="{{ emp.id }}"
                                      data-login-id="{{ emp.user.login_id }}"
                                      data-email="{{ emp.user.email }}"
                                      data-role="{{ emp.user.role }}"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editEmployeeModal">
                                      Edit
                                  </button>
                              </td>
                          </tr>
                          {% endfor %}
                          {% if permanent_employees|length == 0 %}
                          <tr>
                              <td colspan="8" class="text-center">No employee records found.</td>
                          </tr>
                          {% endif %}
                      </tbody>
                  </table>
          </div>
      
      </div>
        </div>

        </div>
    
        
        
        <!-- JO EMPLOYEE -->
        <div class="tab-pane fade" id="navs-pills-JO" role="tabpanel" aria-labelledby="JO-tab">
          <div class="card-header border-bottom p-0 pb-4">
            <h5 class="card-title mb-0">JO Accounts</h5>
        
            </div>
          <div class="card-datable">
            <div class="row mx-1 my-3 align-items-center justify-content-between">
              
              <!-- Left: Length selector -->
              <div class="col-12 col-md-auto mb-3 mb-md-0 ps-0">

              </div>
          
           
            </div>
    
    
            <div class="dt-layout-table" style="height: 100%; display: flex; flex-direction: column;">
                <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
                      <table class="datatables-users table border-top dataTable dtr-column collapsed table-bordered" 
                      id="jobOrderTable" 
                      aria-describedby="DataTables_Table_0_info" 
                      style="width: 100%; height: 100%;">

                      <thead class="table-dark align-middle text-center">
                          <tr>
                              <th>ORGANIZATIONAL UNIT</th>
                              <th>POSITION TITLE</th>
                              <th>FULL NAME</th>
                              <th>EMAIL</th>
                              <th>LOGIN ID</th>
                              <th>ROLE</th>
                              <th>STATUS</th>
                              <th>ACTION</th>
                          </tr>
                      </thead>

                      <tbody>
                          {% for emp in job_order_employees %}
                          <tr>
                              <td>
                                       {{ emp.job_order_details.assigned_department.name if emp.job_order_details.assigned_department else 'No Department Assigned' }}
                              </td>
                              <td>
                                {% if emp.job_order_details and emp.job_order_details.position_title %}
                                  {{ emp.job_order_details.position_title }}
                                {% else %}
                                  N/A
                                {% endif %}
                              </td>

                              <td>
                                 <a href="#" class="text-dark fw-bold text-truncate text-decoration-none">
                                    {{ emp.last_name }} {{ emp.first_name }} {{ emp.middle_name }}
                                  </a>
                              </td>
                              <td>{{ emp.user.email }}</td>
                              <td>{{ emp.user.login_id }}</td>
                              <td>{{ emp.user.role }}</td>
                              <td>{{ emp.status }}</td>
                              <td class="text-center align-middle">
                                  <button type="button" class="btn btn-primary btn-edit"
                                      data-id="{{ emp.id }}"
                                      data-login-id="{{ emp.user.login_id }}"
                                      data-email="{{ emp.user.email }}"
                                      data-role="{{ emp.user.role }}"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editEmployeeModal">
                                      Edit
                                  </button>
                              </td>
                          </tr>
                          {% endfor %}
                          {% if permanent_employees|length == 0 %}
                          <tr>
                              <td colspan="8" class="text-center">No employee records found.</td>
                          </tr>
                          {% endif %}
                      </tbody>
                  </table>
           
            </div>
        
        </div>
          </div>
        </div>
        
      </div>
    </div>
    

</div>
  

<!-- Edit Permanent User Modal -->
<div class="modal fade" id="editEmployeeModal" tabindex="-1" aria-labelledby="editEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editUserForm" method="POST" action="{{ url_for('update_user_account') }}" enctype="multipart/form-data">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editEmployeeModalLabel">Edit User Account</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body row g-3">

          <!-- Hidden Employee ID -->
          <input type="hidden" name="employee_id" id="edit-employee-id">

          <div class="col-md-6">
            <label for="edit-login-id" class="form-label">Login ID</label>
            <input type="text" class="form-control" id="edit-login-id" name="login_id" required>
          </div>

          <div class="col-md-6">
            <label for="edit-email" class="form-label">Email</label>
            <input type="email" class="form-control" id="edit-email" name="email">
          </div>

          <div class="col-md-12">
            <label for="edit-role" class="form-label">Role</label>
            <select class="form-select" id="edit-role" name="role" required>
              <option value="employee">Employee</option>
              <option value="hr">HR</option>
              <option value="head">head</option>
              <!-- Add more roles if needed -->
            </select>
          </div>

          <div id="signature-section" style="display:none;">
          <div class="col-md-12 text-center">
            <label class="form-label">Current Signature</label><br>
            <img id="edit-signature-preview" 
                src="" 
                alt="No Signature Uploaded" 
                class="border rounded" 
                style="max-height: 120px; max-width: 300px;">
          </div>

          <div class="col-md-12">
            <label for="edit-signature-file" class="form-label">Upload New Signature</label>
            <input type="file" class="form-control" id="edit-signature-file" name="signature_file" accept="image/*">
          </div>
          </div>



        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>

        </div>
      </div>
    </form>
  </div>
</div>



<script src="{{ url_for('static', filename='js/savingtabs.js') }}"></script>

  
<script>
document.querySelectorAll('.btn-edit').forEach(button => {
  button.addEventListener('click', function () {
    // Set hidden employee ID
    document.getElementById('edit-employee-id').value = this.dataset.id;

    // Set login ID
    document.getElementById('edit-login-id').value = this.dataset.loginId || '';

    // Set email
    document.getElementById('edit-email').value = this.dataset.email || '';

    // Set role
    const role = this.dataset.role?.toLowerCase();
    const roleSelect = document.getElementById('edit-role');
    if (role && roleSelect) {
      roleSelect.value = role;
    }

    // üîê Role-based signature logic
    const signatureSection = document.getElementById('signature-section');
    const signaturePreview = document.getElementById('edit-signature-preview');

    // Current logged-in user role (injected by Flask)
    const currentUserRole = "{{ current_user.role|lower }}";

    if (currentUserRole === 'hr' || currentUserRole === 'head') {
      // Only show signature section if target user is HR or Head
      if (role === 'hr' || role === 'head') {
        signatureSection.style.display = "block";

        if (this.dataset.signature && this.dataset.signature.trim() !== "") {
  signaturePreview.src = this.dataset.signature;
  signaturePreview.alt = "Employee Signature";
} else {
  signaturePreview.src = "{{ url_for('static', filename='img/no-image.png') }}";
  signaturePreview.alt = "No Signature Uploaded";
}
      } else {
        signatureSection.style.display = "none";
      }
    } else {
      signatureSection.style.display = "none";
    }
  });
});
</script>





  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const orgSelect = document.getElementById("permanentOrg");
    const posSelect = document.getElementById("positionOrg");
    const table = document.getElementById("employeeTable");
    const rows = table.querySelectorAll("tbody tr");

    // Helper: Get trimmed lowercase text from cell
    function getCellText(row, index) {
      return row.cells[index]?.innerText.trim().toLowerCase();
    }

    // Filter the table
  function filterTable() {
    const selectedOrgText = orgSelect.selectedIndex > 0 ? orgSelect.options[orgSelect.selectedIndex].text.toLowerCase() : '';

    const selectedPosText = posSelect.value.toLowerCase();  // use value instead of text

    rows.forEach(row => {
      const orgText = getCellText(row, 0);  // Organizational Unit column
      const posText = getCellText(row, 1);  // Position Title column

      const matchesOrg = !selectedOrgText || orgText === selectedOrgText;
      // If no position selected (empty string), ignore position filter (always true)
      const matchesPos = !selectedPosText || posText === selectedPosText;

      row.style.display = (matchesOrg && matchesPos) ? "" : "none";
    });
  }


    // 1. When org changes, load positions via AJAX and then filter table
    orgSelect.addEventListener("change", function () {
      const departmentId = this.value;


      if (!departmentId) {
        posSelect.innerHTML = '<option value="">Select Position</option>';
        filterTable(); // Show all
        return;
      }

      // Show loading message
      posSelect.innerHTML = '<option value="">Loading...</option>';

      fetch(`/get_positions/${departmentId}`)
        .then(response => response.json())
        .then(data => {
          // Reset positions
          posSelect.innerHTML = '<option value="">Select Position</option>';

          if (data.length > 0) {
            data.forEach(position => {
              const option = document.createElement("option");
              option.value = position.title; // Use title as value for matching
              option.textContent = position.title;
              posSelect.appendChild(option);
            });
          } else {
            posSelect.innerHTML += '<option disabled>No positions found</option>';
          }

          // After loading positions, filter by selected org
          filterTable();
        })
        .catch(error => {
          console.error("Error fetching positions:", error);
          posSelect.innerHTML = '<option disabled>Error loading positions</option>';
        });
    });

    // 2. When position changes, filter the table
    posSelect.addEventListener("change", filterTable);
  });
  </script>



<script>
function setupSearch(inputId, tableId) {
  const searchInput = document.getElementById(inputId);
  const table = document.getElementById(tableId);
  const rows = table.querySelectorAll("tbody tr");

  searchInput.addEventListener("input", function () {
    const keyword = this.value.trim().toLowerCase();

    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(keyword) ? "" : "none";
    });
  });
}

document.addEventListener("DOMContentLoaded", function () {
  setupSearch("search-permanent", "employeeTable");
  setupSearch("search-casual", "casualtbl");
  setupSearch("search-jo", "DataTables_Table_0"); // Or whatever JO table's ID is
});
</script>



<script>
// Live preview when uploading a new signature
document.getElementById("edit-signature-file").addEventListener("change", function (e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function (ev) {
      document.getElementById("edit-signature-preview").src = ev.target.result;
      document.getElementById("edit-signature-preview").alt = "New Signature Preview";
    };
    reader.readAsDataURL(file);
  }
});
</script>

{% block scripts %}
<script>
$(document).ready(function () {
    // Force table layout fixed for all DataTables
    $('table.dataTable').css({
        'table-layout': 'fixed',
        'width': '100%'
    });

    // Common DataTable options with placeholder
    const commonOptions = (placeholder, columnDefs = []) => ({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        autoWidth: false,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        columnDefs: [
            { targets: -1, orderable: false, searchable: false, width: "120px" },
            ...columnDefs
        ],
        dom: '<"row mb-3"<"col-md-6 d-flex align-items-center"f><"col-md-6 text-end"l>>t<"row mt-3"<"col-md-6"i><"col-md-6 text-end"p>>',
        language: {
            search: "",
            searchPlaceholder: placeholder
        }
    });

    // ==============================
    // Permanent Employees Table
    // ==============================
    var employeeTable = $('#employeeTable').DataTable(commonOptions(
        "Search Permanent Employees...",
        [
            { targets: 2, className: "text-wrap", width: "25%" }, // Full Name
            { targets: [0,1], width: "15%" }, // Org Unit + Position
            { targets: 3, width: "20%" },     // Email
            { targets: [4,5], width: "12%" }  // Login ID + Role
        ]
    ));

    // Filter: Organizational Unit
    $('#permanentOrg').on('change', function () {
        var val = this.value ? '^' + $(this).find("option:selected").text() + '$' : '';

        // Reset search for Org Unit (col 0)
        employeeTable.column(0).search(val, true, false).draw();

        // Reset positions dropdown
        $('#positionOrg').empty().append('<option value="">Select Position</option>');

        var positions = {};

        if (this.value) {
            // If a specific department is chosen ‚Üí get positions from filtered rows
            employeeTable.column(1, { search: 'applied' }).data().each(function (d) {
                positions[d] = true;
            });
        } else {
            // If "All Organizational Units" ‚Üí get positions from ALL rows
            employeeTable.column(1).data().each(function (d) {
                positions[d] = true;
            });
        }

        // Rebuild the Position dropdown
        Object.keys(positions).sort().forEach(function (pos) {
            $('#positionOrg').append('<option value="' + pos + '">' + pos + '</option>');
        });

        // Also reset position filter if org changes
        employeeTable.column(1).search('').draw();
    });


    // Filter: Position
    $('#positionOrg').on('change', function () {
        var val = this.value ? '^' + this.value + '$' : '';
        employeeTable.column(1).search(val, true, false).draw();
    });

    // ==============================
    // Casual Employees Table
    // ==============================
    var casualTable = $('#casualTable').DataTable(commonOptions(
        "Search Casual Employees...",
        [{ targets: 2, className: "text-wrap", width: "25%" }]
    ));
    $('#searchCasual').on('keyup', function () {
        casualTable.search(this.value).draw();
    });

    // ==============================
    // Job Order Employees Table
    // ==============================
    var jobOrderTable = $('#jobOrderTable').DataTable(commonOptions(
        "Search Job Order Employees...",
        [{ targets: 2, className: "text-wrap", width: "25%" }]
    ));
    $('#searchJobOrder').on('keyup', function () {
        jobOrderTable.search(this.value).draw();
    });

    // Style search inputs for all tables
    $(".dataTables_filter input")
        .addClass("form-control form-control-lg w-auto")
        .css("margin-left", "0");

    // Style entries dropdown for all tables
    $(".dataTables_length select")
        .addClass("form-select form-select-lg")
        .css("min-width", "80px");

    // Adjust columns when switching Bootstrap tabs
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
        $.fn.dataTable
            .tables({ visible: true, api: true })
            .columns.adjust();
    });
});
</script>
{% endblock %}



  
{% endblock content %}