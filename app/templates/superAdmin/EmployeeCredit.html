{% extends "base/SuperAdmin.html" %}
{% block content %}



<!-- Summary + Charts Row -->
<div class="row mb-4">
  <!-- Summary Row -->
  <div class="col-md-12">
    <div class="card">
      <div class="card-body">
        <div class="row gy-4 gy-sm-1">

          <!-- Vacation Earned -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center border-end pe-lg-3">
              <div>
                <h4 class="mb-0">{{ total_vacation_earned }}</h4>
                <small class="text-muted">Vacation Earned</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-primary">
                  <i class="bi bi-sun fs-3"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Vacation Used -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center border-end pe-lg-3">
              <div>
                <h4 class="mb-0 text-danger">{{ total_vacation_used }}</h4>
                <small class="text-muted">Vacation Used</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-danger">
                  <i class="bi bi-arrow-up-circle fs-3"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Vacation Remaining -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center border-end pe-lg-3">
              <div>
                <h4 class="mb-0 text-success">{{ total_vacation_remaining }}</h4>
                <small class="text-muted">Vacation Remaining</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-success">
                  <i class="bi bi-check-circle fs-3"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Sick Earned -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center border-end pe-lg-3">
              <div>
                <h4 class="mb-0">{{ total_sick_earned }}</h4>
                <small class="text-muted">Sick Earned</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-info">
                  <i class="bi bi-thermometer-half fs-3"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Sick Used -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center border-end pe-lg-3">
              <div>
                <h4 class="mb-0 text-danger">{{ total_sick_used }}</h4>
                <small class="text-muted">Sick Used</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-danger">
                  <i class="bi bi-arrow-up-circle fs-3"></i>
                </span>
              </div>
            </div>
          </div>

          <!-- Sick Remaining -->
          <div class="col-sm-12 col-lg-6 col-xl-2">
            <div class="d-flex justify-content-between align-items-center pe-lg-3">
              <div>
                <h4 class="mb-0 text-success">{{ total_sick_remaining }}</h4>
                <small class="text-muted">Sick Remaining</small>
              </div>
              <div class="avatar">
                <span class="avatar-initial rounded bg-label-success">
                  <i class="bi bi-check2-circle fs-3"></i>
                </span>
              </div>
            </div>
          </div>

        </div> <!-- row gy-4 gy-sm-1 -->
      </div> <!-- card-body -->
    </div> <!-- card -->
  </div> <!-- col-md-12 -->
</div>
<!-- row mb-4 ✅ properly closed -->



<div class="col-xl-12">
  <!-- Employee Credits + Credit History tabs -->
  <div class="nav-align-top mb-4">
    <ul class="nav nav-pills mb-3" role="tablist">


        <li class="nav-item">
          <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                  data-bs-target="#navs-pills-travel-order" id="travel-order-tab" 
                  aria-controls="navs-pills-travel-order" aria-selected="true">
                  Employee Credits
          </button>
        </li>

        <li class="nav-item">
          <button type="button" class="nav-link" role="tab" data-bs-toggle="tab" 
                  data-bs-target="#navs-pills-Leave-Credits" id="Leave-Credits-tab" 
                  aria-controls="navs-pills-Leave-Credits" aria-selected="false">
                  Credit History
          </button>
        </li>
    
      

    
     
      </ul>
    
      <div class="tab-content h-100 min-vh-100">

            <!-- Employee Credit -->
        <div class="tab-pane fade show " id="navs-pills-travel-order" role="tabpanel" aria-labelledby="travel-order-tab">
        
          <div class="card-datable">
            <div class="row mx-1 my-4 align-items-center justify-content-between border-bottom pb-4 mt-2">
              
              <!-- Left: Length selector -->
              <div class="col-12 col-md-auto mb-3 mb-md-0 ps-0">
                <h5 class="card-title mb-0">Employee Credit</h5>

              </div>
          
              <!-- Right: Search, Export, Add -->
             <div class="col-12 col-md d-flex flex-wrap gap-3 justify-content-end align-items-center">
                <div class="btn-group">
                  <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center"
                          type="button"
                          id="exportDropdown"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                    <i class="bi bi-box-arrow-up me-1"></i>
                    <span>Export</span>
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                    <li>
                      <a class="dropdown-item" href="{{ url_for('generate_credit_summary_pdf') }}">
                        <i class="bi bi-file-pdf me-2"></i>Export as PDF
                      </a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item" href="{{ url_for('print_credit_summary') }}" target="_blank">
                        <i class="bi bi-printer me-2"></i>Print
                      </a>
                    </li>
                  </ul>
                </div>
              </div>

            </div>
    
    
            <div class="dt-layout-table" style="height: 100%; display: flex; flex-direction: column;">
                <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
                 <table class="table table-bordered bg-light" id="employeeCreditsTable">
                  <thead class="table-dark text-center">
                    <tr>
                      <th rowspan="2">Employee Name</th>
                      <th rowspan="2">Department</th> <!-- New hidden column for RowGroup -->
                      <th rowspan="2">Position</th>
                      <th colspan="3">Vacation Leave</th>
                      <th colspan="3">Sick Leave</th>
                      <th rowspan="2">Actions</th>
                    </tr>
                    <tr>
                      <th>Earned</th>
                      <th>Used</th>
                      <th>Remaining</th>
                      <th>Earned</th>
                      <th>Used</th>
                      <th>Remaining</th>
                    </tr>
                  </thead>
                  <tbody class="text-center">
                    {% for dept in departments if employees_by_dept.get(dept.name) %}
                      {% for employee in employees_by_dept[dept.name] %}
                        <tr>
                          <td>{{ employee.first_name }} {{ employee.last_name }}</td>
                          <td>{{ dept.name }}</td> <!-- Hidden later in DataTables -->
                          <td>
                            {% if employee.permanent_details %}
                              {{ employee.permanent_details.position.title }}
                            {% elif employee.casual_details %}
                              {{ employee.casual_details.position.title }}
                            {% elif employee.job_order_details %}
                              {{ employee.job_order_details.position_title }}
                            {% else %}
                              -
                            {% endif %}
                          </td>

                          {# Vacation #}
                          <td>{{ '%.2f'|format(employee.credit_balance.vacation_earned) if employee.credit_balance else '0.0' }}</td>
                          <td>{{ '%.2f'|format(employee.credit_balance.vacation_used) if employee.credit_balance else '0.0' }}</td>
                          <td>{{ '%.2f'|format(employee.credit_balance.vacation_remaining) if employee.credit_balance else '0.0' }}</td>

                          {# Sick #}
                          <td>{{ '%.2f'|format(employee.credit_balance.sick_earned) if employee.credit_balance else '0.0' }}</td>
                          <td>{{ '%.2f'|format(employee.credit_balance.sick_used) if employee.credit_balance else '0.0' }}</td>
                          <td>{{ '%.2f'|format(employee.credit_balance.sick_remaining) if employee.credit_balance else '0.0' }}</td>
                          
                          <td>
                            <button 
                              class="btn w-100 btn-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#editCreditModal"
                              data-employee-id="{{ employee.id }}"
                              data-employee-name="{{ employee.first_name }} {{ employee.last_name }}"
                              data-vac-earned="{{ employee.credit_balance.vacation_earned if employee.credit_balance else 0 }}"
                              data-vac-used="{{ employee.credit_balance.vacation_used if employee.credit_balance else 0 }}"
                              data-vac-remaining="{{ employee.credit_balance.vacation_remaining if employee.credit_balance else 0 }}"
                              data-sick-earned="{{ employee.credit_balance.sick_earned if employee.credit_balance else 0 }}"
                              data-sick-used="{{ employee.credit_balance.sick_used if employee.credit_balance else 0 }}"
                              data-sick-remaining="{{ employee.credit_balance.sick_remaining if employee.credit_balance else 0 }}"
                            >
                              Edit
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                  </tbody>
                </table>



            </div>
        
        </div>
          </div>
        </div>

        <!-- Credit History -->
        <div class="tab-pane fade " id="navs-pills-Leave-Credits" role="tabpanel" aria-labelledby="Leave-Credits-tab">

       
        <div class="card-datable">
          <div class="row mx-1 my-4 align-items-center justify-content-between border-bottom pb-4 mt-2">
            
            <!-- Left: Length selector -->
            <div class="col-12 col-md-auto mb-3 mb-md-0 ps-0">
              <h5 class="card-title mb-0">Credit History</h5>

            </div>
        
            <!-- Right: Search, Export, Add -->
           <div class="col-12 col-md d-flex flex-wrap gap-3 justify-content-end align-items-center">
            <!-- Export Button -->
            <div class="btn-group">
              <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center"
                      type="button"
                      id="exportDropdown"
                      data-bs-toggle="dropdown"
                      aria-expanded="false">
                <i class="bi bi-box-arrow-up me-1"></i>
                <span>Export</span>
              </button>
              <ul class="dropdown-menu" aria-labelledby="exportDropdown">
                <li>
                  <a class="dropdown-item" href="{{ url_for('generate_credit_history_pdf') }}">
                    <i class="bi bi-file-pdf me-2"></i>Export as PDF
                  </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                  <a class="dropdown-item" href="{{ url_for('print_credit_history') }}" target="_blank">
                    <i class="bi bi-printer me-2"></i>Print
                  </a>
                </li>
              </ul>
            </div>
          </div>

          </div>
  
  
          <div class="dt-layout-table" style="height: 100%; display: flex; flex-direction: column;">
              <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
             <table class="table table-hover table-bordered text-center align-middle shadow-sm" id="creditTransactionsTable">
              <thead class="table-dark">
                <tr>
                  <th>Employee</th>
                  <th>Department</th> <!-- new hidden column for grouping -->
                  <th>Position</th>
                  <th>Leave Type</th>
                  <th>Action</th>
                  <th>Amount</th>
                  <th>Notes</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
              <tbody>
                {% for dept_name, transactions in credit_transactions_by_dept.items() %}
                  {% for tx in transactions|sort(attribute='timestamp', reverse=True) %}
                    <tr>
                      <!-- Employee -->
                      <td>{{ tx.employee.last_name }}, {{ tx.employee.first_name }} {{ tx.employee.middle_name or '' }}</td>

                      <!-- Department -->
                      <td>{{ dept_name }}</td> <!-- hidden later in DataTables -->

                      <!-- Position -->
                      <td>
                        {% if tx.employee.permanent_details %}
                          {{ tx.employee.permanent_details.position.title }}
                        {% elif tx.employee.casual_details %}
                          {{ tx.employee.casual_details.position.title }}
                        {% elif tx.employee.job_order_details %}
                          {{ tx.employee.job_order_details.position_title }}
                        {% else %}
                          —
                        {% endif %}
                      </td>

                      <!-- Leave Type -->
                      <td>
                        <span class="badge 
                          {% if tx.leave_type == 'Vacation' %}bg-primary
                          {% elif tx.leave_type == 'Sick' %}bg-info
                          {% else %}bg-secondary{% endif %}">
                          {{ tx.leave_type }}
                        </span>
                      </td>

                      <!-- Action -->
                      <td>
                        <span class="badge d-flex align-items-center justify-content-center gap-1
                          {% if tx.action == 'Earned' %}bg-success
                          {% elif tx.action == 'Used' %}bg-warning text-dark
                          {% elif tx.action == 'Edited' %}bg-danger
                          {% else %}bg-secondary{% endif %}">
                          {% if tx.action == 'Earned' %}
                            <i class="bi bi-plus-circle"></i>
                          {% elif tx.action == 'Used' %}
                            <i class="bi bi-dash-circle"></i>
                          {% elif tx.action == 'Edited' %}
                            <i class="bi bi-pencil-square"></i>
                          {% endif %}
                          {{ tx.action }}
                        </span>
                      </td>

                      <!-- Amount -->
                      <td>
                        {% if tx.amount > 0 %}
                          <span class="text-success fw-bold">+{{ '%.1f' | format(tx.amount) }}</span>
                        {% elif tx.amount < 0 %}
                          <span class="text-danger fw-bold">{{ '%.1f' | format(tx.amount) }}</span>
                        {% else %}
                          {{ '%.1f' | format(tx.amount) }}
                        {% endif %}
                      </td>

                      <!-- Notes -->
                      <td><p class="text-secondary">{{ tx.notes or '—' }}</p></td>

                      <!-- Timestamp -->
                      <td>{{ (tx.timestamp|to_ph_time).strftime('%b %d, %Y %I:%M %p') }}</td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8">No credit transactions found.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>


          </div>
      
      </div>
        </div>

        </div>
    
        
      </div>
    </div>
    

</div>
  

<div class="modal fade" id="editCreditModal" tabindex="-1" aria-labelledby="editCreditLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" action="{{ url_for('update_credit') }}">
        <div class="modal-header">
          <h5 class="modal-title" id="editCreditLabel">Edit Employee Credit</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="employee_id" id="employee-id">

          <p class="fs-3 text-primary"><strong id="employee-name"></strong></p>

          <div class="mb-2">
            <label class="form-label">Vacation Earned</label>
            <input type="number" step="0.01" class="form-control" name="vacation_earned" id="vac-earned">
          </div>
          <div class="mb-2">
            <label class="form-label">Vacation Used</label>
            <input type="number" step="0.01" class="form-control" name="vacation_used" id="vac-used">
          </div>
          <div class="mb-2">
            <label class="form-label">Vacation Remaining</label>
            <input type="number" step="0.01" class="form-control" name="vacation_remaining" id="vac-remaining">
          </div>

          <div class="mb-2">
            <label class="form-label">Sick Earned</label>
            <input type="number" step="0.01" class="form-control" name="sick_earned" id="sick-earned">
          </div>
          <div class="mb-2">
            <label class="form-label">Sick Used</label>
            <input type="number" step="0.01" class="form-control" name="sick_used" id="sick-used">
          </div>
          <div class="mb-2">
            <label class="form-label">Sick Remaining</label>
            <input type="number" step="0.01" class="form-control" name="sick_remaining" id="sick-remaining">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Save changes</button>

        </div>
      </form>
    </div>
  </div>
</div>


<script>
  const editModal = document.getElementById('editCreditModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    let button = event.relatedTarget;

    document.getElementById('employee-id').value = button.getAttribute('data-employee-id');
    document.getElementById('employee-name').innerText = button.getAttribute('data-employee-name');

    document.getElementById('vac-earned').value = button.getAttribute('data-vac-earned');
    document.getElementById('vac-used').value = button.getAttribute('data-vac-used');
    document.getElementById('vac-remaining').value = button.getAttribute('data-vac-remaining');

    document.getElementById('sick-earned').value = button.getAttribute('data-sick-earned');
    document.getElementById('sick-used').value = button.getAttribute('data-sick-used');
    document.getElementById('sick-remaining').value = button.getAttribute('data-sick-remaining');
  });
</script>



<!-- SAVING TABS -->
<script src="{{ url_for('static', filename='js/savingtabs.js') }}"></script>

<script>
// EMPLOYEE CREDIT TABLE SEARCH
document.getElementById('searchInput').addEventListener('input', function () {
  const query = this.value.toLowerCase();
  const rows = document.querySelectorAll('#employee-credits-table tbody tr');

  let currentDeptRow = null;
  rows.forEach(row => {
    // Check if it's a department row
    if (row.classList.contains('table-secondary')) {
      currentDeptRow = row;
      row.style.display = ''; // show department header by default
      return;
    }

    const text = row.textContent.toLowerCase();
    const match = text.includes(query);
    row.style.display = match ? '' : 'none';

    // Hide department row if all its employees are hidden
    if (!match && currentDeptRow) {
      const siblingRows = [];
      let next = row.nextElementSibling;
      while (next && !next.classList.contains('table-secondary')) {
        siblingRows.push(next);
        next = next.nextElementSibling;
      }
      const hasVisible = siblingRows.some(r => r.style.display !== 'none');
      currentDeptRow.style.display = hasVisible ? '' : 'none';
    }
  });
});


// CREDIT HISTORY TABLE SEARCH
document.getElementById('searchCasual').addEventListener('input', function () {
  const query = this.value.toLowerCase();
  const rows = document.querySelectorAll('#navs-pills-Leave-Credits tbody tr');

  let currentDeptRow = null;
  rows.forEach(row => {
    if (row.classList.contains('table-secondary')) {
      currentDeptRow = row;
      row.style.display = '';
      return;
    }

    const text = row.textContent.toLowerCase();
    const match = text.includes(query);
    row.style.display = match ? '' : 'none';

    if (!match && currentDeptRow) {
      const siblingRows = [];
      let next = row.nextElementSibling;
      while (next && !next.classList.contains('table-secondary')) {
        siblingRows.push(next);
        next = next.nextElementSibling;
      }
      const hasVisible = siblingRows.some(r => r.style.display !== 'none');
      currentDeptRow.style.display = hasVisible ? '' : 'none';
    }
  });
});
</script>



{% block scripts %}
<script>
$(document).ready(function () {
    // Force table layout fixed for all DataTables
    $('table.dataTable').css({
        'table-layout': 'fixed',
        'width': '100%'
    });

    // Common DataTable options
    const commonOptions = (columnCount, placeholder) => ({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        autoWidth: false,
        dom: '<"row mb-3"<"col-md-6 d-flex align-items-center"f><"col-md-6 text-end"l>>t<"row mt-3"<"col-md-6"i><"col-md-6 text-end"p>>',
        language: {
            search: "",
            searchPlaceholder: placeholder
        }
    });

    // ==============================
    // Employee Credits Table
    // ==============================
    var empCreditsTable = $('#employeeCreditsTable').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        autoWidth: false,
        dom: '<"row mb-3"<"col-md-6 d-flex align-items-center"f><"col-md-6 text-end"l>>t<"row mt-3"<"col-md-6"i><"col-md-6 text-end"p>>',
        language: {
            search: "",
            searchPlaceholder: "Search Employee Credits..."
        },
        rowGroup: {
            dataSrc: 1
        },
        columnDefs: [
            { targets: -1, orderable: false, searchable: false }
        ]
    });

    // ==============================
    // ✅ Credit Transactions Table (single initialization)
    // ==============================
    var creditTxTable = $('#creditTransactionsTable').DataTable(
        $.extend({}, commonOptions(8, "Search Credit Transactions..."), {
            columnDefs: [
                {
                    targets: 7, // Timestamp column index
                    type: 'date', // Sort as date
                }
            ],
            order: [[7, 'desc']] // Sort by Timestamp descending
        })
    );

    // Style search inputs
    $(".dataTables_filter input")
        .addClass("form-control form-control-lg w-auto")
        .css("margin-left", "0");

    // Style entries dropdown
    $(".dataTables_length select")
        .addClass("form-select form-select-lg")
        .css("min-width", "80px");

    // Adjust columns when switching Bootstrap tabs
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
        $.fn.dataTable
            .tables({ visible: true, api: true })
            .columns.adjust();
    });
});
</script>
{% endblock %}





{% endblock content %}