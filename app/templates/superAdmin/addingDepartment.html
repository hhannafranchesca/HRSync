{% extends "base/SuperAdmin.html" %}
{% block content %}

<div class="col-xl-12">

  <div class="nav-align-top mb-4">
    <div class="tab-content h-100 min-vh-100">

      <h2 class="mb-4">Add Department / Positions</h2>
      
      <form method="POST" action="{{ url_for('AddingDepartments') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
      
        <!-- Department Name -->
        <div class="mb-3">
            <label for="name" class="form-label">Department Name</label>
            <input type="text" class="form-control" id="name" name="name" required>
            <div class="invalid-feedback">
              Please provide a department name.
            </div>
          </div>
        
        <!-- Department Description -->
        <div class="mb-4">
            <label for="description" class="form-label">Department Description</label>
            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
        </div>

        <!-- Position Titles, Number of Positions, and Position Type -->
        <div class="mb-3">
            <label class="form-label fs-5">Position Titles and Number of Positions</label>
            <div class="d-flex align-items-center mb-2">
                <input type="text" class="form-control" id="positionInput" placeholder="Type position title">
                <input type="number" class="form-control ms-2" id="numberOfPositionsInput" placeholder="Number of positions" min="1">
                
                <!-- Position Type Dropdown -->
                <select class="form-select ms-2" id="positionTypeInput">
                    <option value="Head">Head</option>
                    <option value="Employee">Employee</option>
         
                </select>
                
                <button class="btn btn-outline-secondary ms-2" type="button" onclick="addPositionRow()">Add</button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle border shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Position Title</th>
                            <th>Number of Positions</th>
                            <th>Position Type</th>
                            <th style="width: 20%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="positionTableBody">
                        <tr id="noPositionRow">
                            <td colspan="5" class="text-center">No Position</td>
                        </tr>
                        <!-- Position rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <hr>

        <!-- Hidden inputs for position submission -->

        <!-- Services Section -->
        <div class="mb-3">
            <label class="form-label fs-5">Services</label>
            <div class="d-flex mb-2">
                <input type="text" class="form-control" id="serviceInput" placeholder="Type service and press Enter">
                <button class="btn btn-outline-secondary ms-2" type="button" onclick="addServiceRow(serviceInput.value)">Add</button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-bordered table-hover align-middle border shadow-sm">
                    <thead class="table-dark">
                        <tr>
                            <th>#</th>
                            <th>Service Name</th>
                            <th style="width: 20%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        <tr id="noServiceRow">
                            <td colspan="3" class="text-center">No Service</td>
                        </tr>
                        <!-- Service rows will be added here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Hidden inputs for service submission -->

        <!-- Submit Button -->
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-primary" id="openConfirmModalBtn">Add Department</button>
        </div>

      </form>

    </div>
  </div>

</div>


<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Submission</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to add this department?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirmSubmitBtn">Yes, Add Department</button>
      </div>
    </div>
  </div>
</div>


<script>
    let serviceCount = document.querySelectorAll('#serviceTableBody tr:not(#noServiceRow)').length || 0;

    const serviceInput = document.getElementById('serviceInput');
    const serviceTableBody = document.getElementById('serviceTableBody');

    serviceInput.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const value = serviceInput.value.trim();
            if (value) {
                addServiceRow(value);
                serviceInput.value = '';
            }
        }
    });

    function addServiceRow(value) {
        serviceCount++;
        const rowId = 'row-' + Date.now();

        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
            <td>${serviceCount}</td>
            <td>
                <input type="text" class="form-control" name="service[]" value="${value}" required>
            </td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="removeServiceRow('${rowId}')">Remove</button>
            </td>
        `;
        serviceTableBody.appendChild(row);

        serviceInput.value = '';
        updateServiceTable();
    }

    function removeServiceRow(rowId) {
        document.getElementById(rowId)?.remove();
        updateServiceTable();
    }

    function updateServiceTable() {
        const rows = serviceTableBody.querySelectorAll('tr');
        const noServiceRow = document.getElementById('noServiceRow');
        if (rows.length > 0) {
            noServiceRow?.remove();
        } else {
            if (!noServiceRow) {
                const emptyRow = document.createElement('tr');
                emptyRow.id = 'noServiceRow';
                emptyRow.innerHTML = `<td colspan="3" class="text-center">No Service</td>`;
                serviceTableBody.appendChild(emptyRow);
            }
        }
    }

    let positionCount = document.querySelectorAll('#positionTableBody tr:not(#noPositionRow)').length || 0;

    const positionInput = document.getElementById('positionInput');
    const numberOfPositionsInput = document.getElementById('numberOfPositionsInput');
    const positionTypeInput = document.getElementById('positionTypeInput');
    const positionTableBody = document.getElementById('positionTableBody');

    function addPositionRow() {
        const positionTitle = positionInput.value.trim();
        const numberOfPositions = numberOfPositionsInput.value.trim();
        const positionType = positionTypeInput.value;

        if (positionTitle && numberOfPositions) {
            positionCount++;
            const rowId = 'row-' + Date.now();

            const row = document.createElement('tr');
            row.id = rowId;
            row.innerHTML = `
                <td>${positionCount}</td>
                <td>
                    <input type="text" class="form-control" name="new_position_title[]" value="${positionTitle}" required>
                </td>
                <td>
                    <input type="number" class="form-control" name="new_number_of_positions[]" value="${numberOfPositions}" min="1" required>
                </td>
                <td>
                    <select class="form-select" name="new_position_type[]">
                        <option value="Head" ${positionType === 'Head' ? 'selected' : ''}>Head</option>
                        <option value="Employee" ${positionType === 'Employee' ? 'selected' : ''}>Employee</option>
                    </select>
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removePositionRow('${rowId}')">Remove</button>
                </td>
            `;
            positionTableBody.appendChild(row);

            // Clear input fields
            positionInput.value = '';
            numberOfPositionsInput.value = '';
            

            updatePositionTable();
        }
    }

    function removePositionRow(rowId) {
        document.getElementById(rowId)?.remove();
        updatePositionTable();
    }

    function updatePositionTable() {
        const rows = positionTableBody.querySelectorAll('tr');
        const noPositionRow = document.getElementById('noPositionRow');
        if (rows.length > 0) {
            noPositionRow?.remove();
        } else {
            if (!noPositionRow) {
                const emptyRow = document.createElement('tr');
                emptyRow.id = 'noPositionRow';
                emptyRow.innerHTML = `<td colspan="5" class="text-center">No Position</td>`;
                positionTableBody.appendChild(emptyRow);
            }
        }
    }
</script>


<script>
(function() {
  'use strict';

  document.addEventListener('DOMContentLoaded', function () {

    const forms = document.querySelectorAll('.needs-validation');

    forms.forEach(function(form) {
        const inputs = form.querySelectorAll('input, textarea, select');
        const openModalBtn = document.getElementById('openConfirmModalBtn');
        const confirmSubmitBtn = document.getElementById('confirmSubmitBtn');
        const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

        // Real-time validation
        inputs.forEach(function(input) {
            const fieldName = input.getAttribute('name') || input.id || 'this field';
            input.addEventListener('input', function () {
                const existingError = input.parentElement.querySelector('.invalid-feedback');
                if (!input.checkValidity()) {
                    if (!existingError) {
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('invalid-feedback');
                        errorMessage.textContent = `Please enter/select a valid ${fieldName.replace('_', ' ')}.`;
                        input.parentElement.appendChild(errorMessage);
                    }
                    input.classList.add('is-invalid');
                } else {
                    input.classList.remove('is-invalid');
                    if (existingError) existingError.remove();
                }
            });
        });

        // Open modal only if form is valid
        openModalBtn.addEventListener('click', function() {
            let isValid = true;

            // Trigger validation for all inputs
            inputs.forEach(input => {
                if (!input.checkValidity()) {
                    isValid = false;
                    const existingError = input.parentElement.querySelector('.invalid-feedback');
                    if (!existingError) {
                        const errorMessage = document.createElement('div');
                        errorMessage.classList.add('invalid-feedback');
                        errorMessage.textContent = `Please enter/select a valid ${input.getAttribute('name') || input.id || 'this field'}.`;
                        input.parentElement.appendChild(errorMessage);
                    }
                    input.classList.add('is-invalid');
                }
            });

            if (isValid) {
                confirmModal.show();
            }
        });

        // Submit form when user confirms in modal
        confirmSubmitBtn.addEventListener('click', function() {
            confirmModal.hide();
            form.submit();
        });
    });
  });
})();
</script>

    
  
  
{% endblock content %}
