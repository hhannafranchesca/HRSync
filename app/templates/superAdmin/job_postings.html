{% extends "base/SuperAdmin.html" %}
{% block content %}





<div class="row g-4 mb-4">
  
    <div class="col-12 col-sm-6 col-xl-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-heading">Job Post</span>
              <div class="d-flex align-items-center my-1">
                <h4 class="mb-0 me-2 fs-3 fw-semibold">{{ job_count }}</h4>
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-primary">
                <i class="bi bi-signpost fs-3"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  
    <div class="col-12 col-sm-6 col-xl-6">
      <div class="card">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div class="content-left">
              <span class="text-heading">Total Applicants</span>
              <div class="d-flex align-items-center my-1">
                <h4 class="mb-0 me-2 fs-3 fw-semibold">{{ total_applicants or 0 }}</h4>
                <!-- <p class="text-success mb-0">(+29%)</p> -->
              </div>
            </div>
            <div class="avatar">
              <span class="avatar-initial rounded bg-label-primary">
                <i class="bi bi-people fs-3"></i>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<div class="card h-100 min-vh-100 d-flex flex-column">
 
        <div class="card-datable">
          <div class="row mx-1 my-1 align-items-center justify-content-between border-bottom pb-4 mt-2">

                <div class="col-12 col-md-auto mb-3 mb-md-0">
                          <h5 class="card-title mb-0">Manage Job Post</h5>

                  </div>

                 {% if current_user.has_permission('write_hiring') %}
                  <div class="col-12 col-md d-flex justify-content-end mt-3 mt-md-0">
                      <button class="btn btn-primary d-flex align-items-center" type="button" data-bs-toggle="modal" data-bs-target="#addJobModal">
                          <i class="bi bi-plus me-1"></i>
                          <span>Add Job Post</span>
                      </button>
                  </div>
                  {% endif %}

            
            </div>


            <div class="dt-layout-table p-3 pt-0" style="height: 100%; display: flex; flex-direction: column;">
                <div class="d-md-flex justify-content-between align-items-center dt-layout-full table-responsive" style="flex: 1; overflow: auto;">
                
                    <table class="datatables-users table table-bordered border-top dataTable dtr-column collapsed" 
                        id="jobtbl" 
                        aria-describedby="DataTables_Table_0_info" 
                        style="width: 100%; height: 100%;">

                        <thead class="table-dark align-middle text-center">
                            <tr>
                        
                            <th data-dt-column="1" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">TITLE</span>
                                <span class="dt-column-order"></span>
                            </th>
                        
                            <th data-dt-column="2" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">DEPARTMENT</span>
                                <span class="dt-column-order"></span>
                            </th>
                            
                        
                            <th data-dt-column="3" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">DESCRIPTION</span>
                                <span class="dt-column-order"></span>
                            </th>
                        
                            <th data-dt-column="4" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">REQUIREMENTS</span>
                                <span class="dt-column-order"></span>
                            </th>
                        
                   
                        
                            <th data-dt-column="5" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">STATUS</span>
                                <span class="dt-column-order"></span>
                            </th>
                        
                            <th data-dt-column="6" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">DATE POSTED</span>
                                <span class="dt-column-order"></span>
                            </th>

         
                        
                            <th data-dt-column="7" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                                <span class="dt-column-title" role="button">POSITION</span>
                                <span class="dt-column-order"></span>
                            </th>

                            
                            <th data-dt-column="8" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                              <span class="dt-column-title" role="button">APPLICANTS</span>
                              <span class="dt-column-order"></span>
                            </th>

                            <th data-dt-column="9" class="dt-orderable-asc dt-orderable-desc" tabindex="0">
                              <span class="dt-column-title" role="button">ACTION</span>
                          </th>
        
                            </tr>
                        </thead>

                        <tbody>
                          {% for job in job_postings %}
                          
                            <tr class="align-middle text-center">
                              <td>{{ job.title }}</td>
                              <td>{{ job.department.name if job.department else 'N/A' }}</td>
                              <td>{{ job.description[:100] }}{% if job.description|length > 100 %}...{% endif %}</td>
                            
                              <td class="text-start">
                                <div class="text-center">
                                  <!-- Collapse target -->
                                  <div class="collapse requirements-box" id="req-{{ job.id }}">
                                    <ul class="mb-0">
                                      {% for item in job.qualifications.split(';;;') if item.strip() %}
                                        <li>{{ item.strip() }}</li>
                                      {% endfor %}
                                    </ul>
                                  </div>

                                  <!-- Toggle button -->
                                  <a class="btn btn-link p-0 show-more"
                                    data-bs-toggle="collapse"
                                    href="#req-{{ job.id }}"
                                    role="button"
                                    aria-expanded="false"
                                    aria-controls="req-{{ job.id }}">
                                    Toggle View
                                  </a>
                                </div>
                              </td>


                              <td>
                                <span class="badge bg-{{ 'success' if job.status == 'Open' else 'secondary' }}">
                                  {{ job.status }}
                                </span>
                              </td>
                              <td>{{ (job.created_at | to_ph_time).strftime('%B %d, %Y %I:%M %p') if job.created_at else '-' }}</td>
                              <td>
                                {% if job.job_position_type == 'Permanent' %}
                                  <span class="badge border border-success text-success">Permanent</span>
                                {% elif job.job_position_type == 'Casual' %}
                                  <span class="badge border border-warning text-warning">Casual</span>
                                {% elif job.job_position_type == 'Job Order' %}
                                  <span class="badge border border-primary text-primary">Job Order</span>
                                {% else %}
                                  <span class="badge border border-secondary text-secondary">{{ job.job_position_type }}</span>
                                {% endif %}
                              </td>

                              <td>{{ job.applicants|length }}</td>
                              
                              <td>
                                
                                
                                <div class="d-grid gap-2">
                                  <!-- View Button -->
                                  <a href="{{ url_for('JobApplicants', job_id=job.id) }}" class="btn btn-sm btn-primary">
                                    View
                                  </a>
  
                                {% if current_user.has_permission('write_hiring') %}
                                  <!-- Example action buttons -->
                                  <button
                                      class="btn btn-sm btn-info edit-job-btn"
                                      data-id="{{ job.id }}"
                                      data-title="{{ job.title }}"
                                      data-department="{{ job.department_id }}"
                                      data-type="{{ job.job_position_type }}"
                                      data-description="{{ job.description }}"
                                      data-qualifications="{{ job.qualifications }}"
                                      data-status="{{ job.status }}"
                                      data-number_of_openings="{{ job.number_of_openings }}"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editJobModal">
                                      Edit
                                  </button>
                                  
                                 <button type="button" 
                                        class="btn btn-sm btn-danger" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#closeJobModal" 
                                        data-job-id="{{ job.id }}">
                                  Close
                                </button>
                                {% endif %}

                                </div>

                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                        

                    </table>
                </div>
            </div>
        </div>
        

    </div>
</div>

<!-- Add Job Post Modal -->
<div class="modal fade" id="addJobModal" tabindex="-1" aria-labelledby="addJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form action="{{ url_for('add_job_post') }}" method="POST">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addJobModalLabel">Add New Job Posting</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">

          <div class="row mb-3">

            <div class="col-md-6 mb-3">
              <label for="jobTitle" class="form-label">Job Title<span class="text-danger">*</span></label>
              <input type="text" name="title" class="form-control" id="jobTitle" required>
            </div>

          <!-- Department -->
          <div class="col-md-6 mb-3">
            <label for="department" class="form-label">Department<span class="text-danger">*</span></label>
            <select name="department_id" class="form-select" id="department" required>
              <option selected disabled>Choose department</option>
              {% for dept in departments %}
                <option value="{{ dept.id }}">{{ dept.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label for="jobPosition" class="form-label">Job Position Type <span class="text-danger">*</span></label>
            <select name="job_position_type" class="form-select" id="jobPosition" required>
              <option selected disabled>Choose job type</option>
              <option value="Permanent">Permanent</option>
              <option value="Job Order">Job Order</option>
              <option value="Casual">Casual</option>
            </select>
          
          </div>


          <div class="col-md-6 mb-3">
              <label for="numberOfOpenings" class="form-label">Number of Openings <span class="text-danger">*</span></label>
              <input type="number" name="number_of_openings" class="form-control" id="numberOfOpenings" min="1" required placeholder="e.g., 3">
          </div>

          </div>

          <!-- Description -->
          <div class="mb-3">
            <label for="description" class="form-label">Job Description<span class="text-danger">*</span></label>
            <textarea name="description" class="form-control" id="description" rows="3" placeholder="Describe responsibilities, working hours, environment, etc."></textarea>
          </div>

          <!-- Qualifications -->
          <div class="mb-3">
            <label class="form-label">Qualifications<span class="text-danger">*</span></label>
            <div id="qualifications-list">
              <div class="input-group mb-2 qualification-item">
                <input type="text" name="qualifications[]" class="form-control" placeholder="Enter a qualification" required>
                <button type="button" class="btn btn-outline-danger" onclick="removeQualification(this)">Remove</button>
              </div>
            </div>
            <button type="button" class="btn btn-outline-success" onclick="addQualification()">Add Qualification</button>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Post Job</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- JS FOR ADDING QUALIFICATION -->
<script>
  function addQualification() {
    const container = document.getElementById('qualifications-list');
    const div = document.createElement('div');
    div.classList.add('input-group', 'mb-2', 'qualification-item');
    div.innerHTML = `
      <input type="text" name="qualifications[]" class="form-control" placeholder="Enter a qualification" required>
      <button type="button" class="btn btn-danger" onclick="removeQualification(this)">Remove</button>
    `;
    container.appendChild(div);
  }

  function removeQualification(button) {
    button.parentElement.remove();
  }
</script>

<!-- Edit Job Modal -->
<div class="modal fade" id="editJobModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form method="POST" action="{{ url_for('update_job_post') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Job Posting</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <input type="hidden" name="id" id="edit-id">
          
          <div class="row mb-3">
            <div class="col-md-6 mb-3">
                <label for="edit-title" class="form-label">Title</label>
                <input type="text" class="form-control" name="title" id="edit-title" required>
            </div>

            <div class="col-md-6 mb-3mb-3">
                <label for="edit-department" class="form-label">Department</label>
                <select name="department_id" id="edit-department" class="form-control">
                  {% for dept in departments %}
                    <option value="{{ dept.id }}">{{ dept.name }}</option>
                  {% endfor %}
                </select>
            </div>

            <div class="col-md-6">
              <label for="edit-type" class="form-label">Job Type</label>
              <select name="job_position_type" id="edit-type" class="form-control" required>
                <option value="Permanent">Permanent</option>
                <option value="Casual">Casual</option>
                <option value="Job Order">Job Order</option>
                <option value="Contractual">Contractual</option>
              </select>
            </div>

            <div class="col-md-6">
              <label for="numberOfOpenings" class="form-label">Number of Openings <span class="text-danger">*</span></label>
              <input type="number" name="number_of_openings" class="form-control" id="edit-numberOfOpenings" min="1" required placeholder="e.g., 3">
            </div>
          
          </div>

        

         


          <div class="mb-3">
            <label for="edit-description" class="form-label">Description</label>
            <textarea name="description" class="form-control" id="edit-description" rows="3"></textarea>
          </div>

           <div class="mb-3">
            <label class="form-label">Qualifications</label>
            <div id="edit-qualifications-list">
              <!-- Individual qualification items will be added dynamically via JS -->
            </div>
            <button type="button" class="btn btn-outline-success mt-2" onclick="addEditQualification()">Add Qualification</button>
          </div>

          <div class="mb-3">
            <label for="edit-status" class="form-label">Status</label>
            <select name="status" id="edit-status" class="form-control">
              <option value="Open">Open</option>
              <option value="Closed">Closed</option>
            </select>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>




<!-- Close Job Modal -->
<div class="modal fade" id="closeJobModal" tabindex="-1" aria-labelledby="closeJobModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('close_job_posting') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="closeJobModalLabel">Confirm Close</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to close this job posting?
          <input type="hidden" name="job_id" id="closeJobId">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Confirm Close</button>
        </div>
      </div>
    </form>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
  const deptSelect = document.getElementById('casualtOrg');
  const statusSelect = document.getElementById('FilterTransaction');
  const table = document.getElementById('jobtbl');
  const rows = table.querySelectorAll('tbody tr');

  function filterTable() {
    const selectedDept = deptSelect.options[deptSelect.selectedIndex].text.trim();
    const selectedStatus = statusSelect.value;

    rows.forEach(row => {
      const deptCell = row.children[1]?.textContent.trim(); // 2nd <td> = department
      const statusCell = row.children[4]?.textContent.trim(); // 5th <td> = status badge

      const deptMatch = (selectedDept === 'All Departments' || deptCell === selectedDept);
      const statusMatch = (!selectedStatus || selectedStatus === 'All' || statusCell === selectedStatus);

      row.style.display = (deptMatch && statusMatch) ? '' : 'none';
    });
  }

  deptSelect.addEventListener('change', filterTable);
  statusSelect.addEventListener('change', filterTable);
});
</script>



<!-- for Deletign Job -->
<script>
  const closeJobModal = document.getElementById('closeJobModal');
  closeJobModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const jobId = button.getAttribute('data-job-id');
    const input = closeJobModal.querySelector('#closeJobId');
    input.value = jobId;
  });
</script>

<script>
  document.querySelectorAll('.edit-job-btn').forEach(button => {
    button.addEventListener('click', () => {
      // Set basic fields
      document.getElementById('edit-id').value = button.dataset.id;
      document.getElementById('edit-title').value = button.dataset.title;
      document.getElementById('edit-department').value = button.dataset.department;
      document.getElementById('edit-type').value = button.dataset.type;
      document.getElementById('edit-description').value = button.dataset.description;
      document.getElementById('edit-status').value = button.dataset.status;
      document.getElementById('edit-numberOfOpenings').value = button.dataset.number_of_openings;

      // --- Populate dynamic qualifications ---
      const container = document.getElementById('edit-qualifications-list');
      container.innerHTML = ''; // Clear previous items

      if (button.dataset.qualifications) {
        // Split by unique separator ';;;'
        const qualifications = button.dataset.qualifications.split(';;;').map(q => q.trim());
        qualifications.forEach(q => addEditQualification(q));
      }
    });
  });

  // Add a qualification input dynamically
  function addEditQualification(value = '') {
    const container = document.getElementById('edit-qualifications-list');
    const div = document.createElement('div');
    div.classList.add('input-group', 'mb-2', 'qualification-item');
    div.innerHTML = `
      <input type="text" name="qualifications[]" class="form-control" placeholder="Enter a qualification" value="${value}" required>
      <button type="button" class="btn btn-outline-danger" onclick="removeQualification(this)">Remove</button>
    `;
    container.appendChild(div);
  }

  // Remove a qualification input
  function removeQualification(button) {
    button.parentElement.remove();
  }
</script>



<script>

  function enableTableSearch(inputId, tableId) {
    const searchInput = document.getElementById(inputId);
    const table = document.getElementById(tableId);

    if (!searchInput || !table) {
      console.warn(`Search input or table not found: #${inputId}, #${tableId}`);
      return;
    }

    const tbody = table.querySelector("tbody");
    const rows = tbody.getElementsByTagName("tr");

    searchInput.addEventListener("input", function () {
      const filter = searchInput.value.toLowerCase();
      Array.from(rows).forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? "" : "none";
      });
    });
  }

  // Example usage after DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {

    enableTableSearch("searchJob", "jobtbl");

  });
</script>


{% block scripts %}
<script>
$(document).ready(function () {
    // Force fixed layout to avoid right-side spacing
    $('#jobtbl').css({
        'table-layout': 'fixed',
        'width': '100%'
    });

    // Initialize DataTable
    var jobTable = $('#jobtbl').DataTable({
        paging: true,
        searching: true,
        ordering: true,
        responsive: true,
        autoWidth: false,
        pageLength: 10,
        lengthMenu: [5, 10, 25, 50, 100],
        columnDefs: [
            { targets: 0, className: "text-wrap", width: "15%" }, // Title
            { targets: 1, width: "12%" }, // Department
            { targets: 2, className: "text-wrap text-start", width: "20%" }, // Description
            { targets: 3, className: "text-start text-wrap", width: "20%" }, // Requirements
            { targets: 4, width: "8%" }, // Status
            { targets: 5, width: "10%" }, // Date Posted
            { targets: 6, width: "10%" }, // Position
            { targets: 7, width: "8%" }, // Applicants
            { targets: 8, orderable: false, searchable: false, width: "10%" } // Action
        ],
        order: [[5, 'desc']], // Default sort by Date Posted
        dom: '<"row mb-3"<"col-md-6 d-flex align-items-center"f><"col-md-6 text-end"l>>' +
             't' +
             '<"row mt-3"<"col-md-6"i><"col-md-6 text-end"p>>',
        language: {
            search: "",
            searchPlaceholder: "Search Job Postings..."
        }
    });

    // Style search input
    $(".dataTables_filter input")
        .addClass("form-control form-control-lg w-auto")
        .css("margin-left", "0");

    // Style entries dropdown
    $(".dataTables_length select")
        .addClass("form-select form-select-lg")
        .css("min-width", "80px");
});
</script>
{% endblock %}




{% endblock content %}