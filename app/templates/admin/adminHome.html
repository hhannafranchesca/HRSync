{% extends "base/AdminDashboard.html" %}
{% block content %}



<style>
   
/* Calendar container */
#calendar {
  font-size: 0.9rem;
  background-color: #fff;
  border-radius: 0.75rem;
  padding: 1.5rem;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.03);
}

.fc .fc-toolbar-title {
  font-size: 1.3rem; /* or 24px */
  font-weight: bold;
}

/* Calendar buttons */
.fc .fc-button {
  background-color: #1f2937; /* Gray-800 */
  color: #fff;
  border: none;
  font-size: 0.9rem;
  padding: 0.45rem 0.9rem;
  margin: 0 2px;
  border-radius: 0.375rem;
  text-transform: capitalize;
  transition: all 0.2s ease-in-out;
}



/* Month & general views */
.fc-event {
  border-radius: 0.5rem;
  padding: 1px 8px;
  font-size: 0.975rem;
  font-weight: 500;
  border: 1px solid #cbd5e1;
  color: #fff !important;
  background-color: #6c757d; /* fallback default */
  transition: all 0.2s ease-in-out;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
}
.fc .fc-toolbar-chunk .fc-today-button {
  margin-left: 15px;   /* space sa gilid */
  margin-top: 4px;    /* dagdag space sa taas */
}

/* Week/Day view (timeGrid) */
.fc-timegrid-event-harness .fc-event,
.fc-timegrid-event .fc-event-main {
  color: #fff !important;
  background-color: inherit !important;
  border: none !important;
}

/* List view */
.fc-list-event {
  background-color: inherit !important;
  border-left: 4px solid currentColor;
}
.fc-list-event .fc-event-title,
.fc-list-event-title {
  color: #fff !important;
}

/* Hover */
.fc-event:hover {
  opacity: 0.95;
  transform: scale(1.02);
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
  z-index: 10;
}

/* Label colors - readable text for light backgrounds */
.fc-event.fc-primary, .fc-primary {
  background-color: #dbeafe !important;
  color: #1d4ed8 !important;
}
.fc-event.fc-success, .fc-success {
  background-color: #dcfce7 !important;
  color: #15803d !important;
}
.fc-event.fc-danger, .fc-danger {
  background-color: #fee2e2 !important;
  color: #b91c1c !important;
}
.fc-event.fc-warning, .fc-warning {
  background-color: #fef3c7 !important;
  color: #92400e !important;
}
.fc-event.fc-info-solid, .fc-info-solid {
  background-color: #cffafe !important;
  color: #0369a1 !important;
}
.fc-event.fc-warning-solid, .fc-warning-solid {
  background-color: #fef9c3 !important;
  color: #78350f !important;
}
.fc-event.fc-primary-solid, .fc-primary-solid {
  background-color: #e0f2fe !important;
  color: #1e3a8a !important;
}
.fc-event.fc-default, .fc-default {
  background-color: #f3f4f6 !important;
  color: #374151 !important;
}
/* Apply text color directly inside event content */
.fc-event .fc-event-title,
.fc-event .fc-event-time,
.fc-event .fc-event-main {
  color: inherit !important;
}
/* Remove event border */
.fc-event {
  border: none !important;
  box-shadow: none !important;
}

.fc .fc-list-event:hover td {
  background-color: rgba(0, 0, 0, 0.05) !important; /* subtle dark */
}

/* Make FullCalendar toolbar responsive */
@media (max-width: 768px) {
  .fc .fc-toolbar {
    flex-direction: column !important;
    align-items: center !important;
    gap: 0.5rem;
  }

  .fc .fc-toolbar-chunk {
    width: 100%;
    display: flex;
    justify-content: center;
    flex-wrap: wrap; /* para hindi dikit yung buttons */
    gap: 0.25rem;
  }

  .fc .fc-toolbar-title {
    font-size: 1rem; /* paliitin yung title sa mobile */
    text-align: center;
  }
}

</style>

<div class="row g-3">

  <!-- FULL-WIDTH STATIC USER INFO CARD -->
  <div class="col-12 col-md-8">
  <div class="card shadow-sm border-0 rounded-4 p-3" style="min-height: 160px;">
    <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
      
      <!-- User Avatar & Info -->
      <div class="d-flex align-items-center gap-3">
          <img
            src="{{ url_for('static', filename='img/avatars/' ~ current_user.image_file) if current_user.image_file and current_user.image_file != 'default.jpg' else url_for('static', filename='img/avatars/default.png') }}"
            alt="User Avatar"
            class="rounded-circle border border-2 border-primary"
            width="100"
            height="100"
          />
        <div>
          <h4 class="mb-1 fw-bold"> {{ current_user.employee.last_name }}, {{ current_user.employee.first_name }} {{ current_user.employee.middle_name[0] }}.</h4>
          <p class="mb-1 text-muted">{{ current_user.email }}</p>
          <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary px-3 py-2">
                  {% if current_user.employee %}
                    {% if current_user.employee.permanent_details %}
                      {{ current_user.employee.permanent_details.position.title }}
                    {% elif current_user.employee.casual_details %}
                      {{ current_user.employee.casual_details.position.title }}
                    {% elif current_user.employee.job_order_details %}
                      {{ current_user.employee.job_order_details.position_title }}
                    {% else %}
                      No Position
                    {% endif %}
                  {% else %}
                    No Position
                  {% endif %}
                </span>

                  <span class="badge bg-secondary px-3 py-2">
                {% if current_user.employee %}
                  {% if current_user.employee.casual_details and current_user.employee.casual_details.assigned_department %}
                    {{ current_user.employee.casual_details.assigned_department.name }}
                  {% elif current_user.employee.job_order_details and current_user.employee.job_order_details.assigned_department %}
                    {{ current_user.employee.job_order_details.assigned_department.name }}
                  {% elif current_user.employee.department %}
                    {{ current_user.employee.department.name }}
                  {% else %}
                    No Department
                  {% endif %}
                {% else %}
                  No Department
                {% endif %}
              </span>
                

          </div>
        </div>
      </div>


  


      <!-- Action Buttons -->
      <div class="text-md-end text-center">
        <a href="{{ url_for('adminaccount') }}" class="btn btn-outline-primary btn-lg me-2">
        <i class="bi bi-pencil me-1"></i> Edit Profile
      </a>

      </div>

    </div>
  </div>
</div>

  <div class="col-12 col-md-4">
  <div class="card shadow-sm border-0 rounded-4 h-100">
    <div class="card-body d-flex flex-column">
      
      <!-- Header -->
      <div class="d-flex align-items-center justify-content-between mb-3">
        <h6 class="fw-semibold mb-0">
          <i class="bi bi-wallet2 me-2 text-primary"></i> Credit Balance
        </h6>
      </div>

      {% if current_user.employee and current_user.employee.credit_balance %}
        <!-- Credits Grid -->
        <div class="row g-3 mb-2">
          <!-- Vacation -->
          <div class="col-6">
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                <i class="bi bi-sun-fill fs-5"></i>
              </div>
              <div>
                <div class="fw-semibold text-primary small">Vacation Leave</div>
                <div class="fs-5 fw-bold">{{ current_user.employee.credit_balance.vacation_remaining }}</div>
                <small class="text-muted">days left</small>
              </div>
            </div>
          </div>

          <!-- Sick -->
          <div class="col-6">
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                <i class="bi bi-heart-pulse-fill fs-5"></i>
              </div>
              <div>
                <div class="fw-semibold text-info small">Sick Leave</div>
                <div class="fs-5 fw-bold">{{ current_user.employee.credit_balance.sick_remaining }}</div>
                <small class="text-muted">days left</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Last updated -->
        <div class="text-muted small mt-auto text-start">
          <i class="bi bi-clock-history me-1"></i>
          Last updated: {{ current_user.employee.credit_balance.last_updated.strftime('%b %d, %Y %I:%M %p') }}
        </div>
      {% else %}
        <div class="text-muted fst-italic">No credit record available.</div>
      {% endif %}

    </div>
  </div>
</div>




  <!-- LEFT COLUMN -->
  <div class="col-md-12">
    <!-- Total Employees & Performance -->
    <div class="card ">
      <div class="card-body">
     <div class="row gy-4 gy-sm-1">

  <!-- Employees -->
  <div class="col-sm-6 col-lg-4 border-end">
    <div class="d-flex justify-content-between align-items-center border-end-lg pe-lg-3">
      <div>
        <h4 class="mb-0">{{ total_employees or 0 }}</h4>
        <small class="text-muted">Employees</small>
      </div>
      <div class="avatar">
        <span class="avatar-initial rounded bg-label-primary">
          <i class="bi bi-person fs-3"></i>
        </span>
      </div>
    </div>
  </div>

  <!-- Submitted IPCR -->
  <div class="col-sm-6 col-lg-4 border-end">
    <div class="d-flex justify-content-between align-items-center border-end-lg pe-lg-3">
      <div>
        <h4 class="mb-0">{{ submitted_ipcr or 0 }}</h4>
        <small class="text-muted">Submitted IPCR</small>
      </div>
      <div class="avatar">
        <span class="avatar-initial rounded bg-label-success">
          <i class="bi bi-bar-chart-line fs-3"></i>
        </span>
      </div>
    </div>
  </div>

  


  <!-- Approved IPCR -->
  <div class="col-sm-6 col-lg-4">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h4 class="mb-0">{{ approved_ipcr or 0 }}</h4>
        <small class="text-muted">Graded IPCR</small>
      </div>
      <div class="avatar">
        <span class="avatar-initial rounded bg-label-info">
          <i class="bi bi-check-circle fs-3"></i>
        </span>
      </div>
    </div>
  </div>

</div>

      </div>
    </div>
  </div>




  <!-- LEFT: Calendar (Responsive Half Width) -->
   <div class="col-md-6">
    <div class="card h-100" style="min-height: 690px;">
    <div class="card-header d-flex justify-content-between align-items-center pb-0">
      <h5 class="mb-0">
        <i class="bi bi-calendar-event me-2"></i> Schedule Calendar
      </h5>
    </div>
    <div class="card-body pt-3">
        <div id="calendar" class="mt-2"></div>
      </div>
  </div>
</div>

  <!-- RIGHT: Two stacked cards -->
  <div class="col-md-6 d-flex flex-column gap-3">
    <!-- Employee Chart + IPCR Progress -->
    <div class="card shadow-sm w-100">
      <div class="card-header py-2">
        <div class="row w-100 mt-3">
          <!-- Left Title -->
          <div class="col-6 d-flex align-items-center">
            <h6 class="card-title mb-0">
              <i class="bi bi-people-fill me-2"></i>Employee Distribution Overview
            </h6>
          </div>

          <!-- Right Title: Aligned immediately after center line -->
          <div class="col-6 d-flex align-items-center" style="padding-left: 1.5rem;">
            <h6 class="card-title mb-0">
              <i class="bi bi-clipboard-data-fill me-2"></i>Department IPCR Submission
            </h6>
          </div>
        </div>
      </div>

      <div class="card-body p-2">
        <div class="row h-100">
          <!-- Left: Employee Distribution Chart -->
          <div class="col-6 d-flex justify-content-center align-items-center border-end" style="height: 270px;">
            <div id="employeeChart" style="width: 100%; max-width: 250px;"></div>
          </div>

          <!-- Right: Department-Specific IPCR Progress Chart -->
          <div class="col-6 d-flex flex-column justify-content-center align-items-center text-center" style="height: 270px;">
            <div id="deptIPCRChart" style="height: 200px; width: 100%; max-width: 250px;"></div>
            <small class="mt-2 text-muted">{{ evaluation_period_name }}</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Placeholder Card -->
    <!-- Split Cards for Leave and On Travel Employees -->
<!-- Split Cards for Leave and On Travel Employees -->
<div class="row g-3">

  <!-- Employees on Leave -->
  <div class="col-12 col-md-6 d-flex flex-column">
    <div class="card flex-fill shadow-sm h-100">
      <div class="card-header bg-light d-flex align-items-center">
        <i class="bi bi-person-dash-fill me-2"></i>
        <strong>Employees on Leave</strong>
      </div>
      <div class="card-body" style="min-height: 300px; overflow-y: auto;">
        {% if current_leave_employees %}
          <ul class="list-group list-group-flush">
            {% for permit in current_leave_employees %}
              {% set emp = permit.employee %}
              {% set user = emp.user if emp and emp.user else None %}
              <li class="list-group-item px-0">
                <div class="d-flex align-items-start gap-3">
                  {% if user and user.image_file and user.image_file != 'default.jpg' %}
                    <img src="{{ url_for('static', filename='img/avatars/' ~ user.image_file) }}"
                         class="rounded-circle border" width="40" height="40" alt="Avatar">
                  {% else %}
                    <div class="rounded-circle text-white d-flex justify-content-center align-items-center bg-avatar-{{ loop.index0 % 8 }}"
                         style="width: 40px; height: 40px;">
                      {{ (emp.first_name[0] ~ emp.last_name[0]).upper() }}
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                      <h6 class="mb-0 text-truncate">
                        {{ emp.last_name }}, {{ emp.first_name }}{% if emp.middle_name %} {{ emp.middle_name }}{% endif %}
                      </h6>
                      <small class="text-muted ms-2">
                        {{ permit.leave_detail.date_from.strftime('%b %d') }} - {{ permit.leave_detail.date_to.strftime('%b %d') }}
                      </small>
                    </div>
                    <small class="text-muted d-block text-truncate">{{ permit.leave_detail.leave_type }}</small>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted mb-0">No employees on leave today.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Employees on Travel -->
  <div class="col-12 col-md-6 d-flex flex-column">
    <div class="card flex-fill shadow-sm h-100">
      <div class="card-header bg-light d-flex align-items-center">
        <i class="bi bi-geo-alt-fill me-2"></i>
        <strong>Employees on Travel</strong>
      </div>
      <div class="card-body" style="min-height: 300px; overflow-y: auto;">
        {% if current_travel_employees %}
          <ul class="list-group list-group-flush">
            {% for permit in current_travel_employees %}
              {% set emp = permit.employee %}
              {% set user = emp.user if emp and emp.user else None %}
              <li class="list-group-item">
                <div class="d-flex align-items-start gap-3">
                  {% if user and user.image_file and user.image_file != 'default.jpg' %}
                    <img src="{{ url_for('static', filename='img/avatars/' ~ user.image_file) }}"
                         class="rounded-circle border" width="40" height="40" alt="Avatar">
                  {% else %}
                    <div class="rounded-circle text-white d-flex justify-content-center align-items-center bg-avatar-{{ loop.index0 % 8 }}"
                         style="width: 40px; height: 40px;">
                      {{ (emp.first_name[0] ~ emp.last_name[0]).upper() }}
                    </div>
                  {% endif %}
                  <div class="flex-grow-1">
                    <div class="d-flex justify-content-between align-items-center">
                      <h6 class="mb-0 text-truncate">
                        {{ emp.last_name }}, {{ emp.first_name }}{% if emp.middle_name %} {{ emp.middle_name }}{% endif %}
                      </h6>
                      <small class="text-muted ms-2">
                        {{ permit.travel_detail.date_departure.strftime('%b %d, %Y') }}
                      </small>
                    </div>
                    <small class="text-muted d-block text-truncate">{{ permit.travel_detail.destination }}</small>
                  </div>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <span class="text-muted">No travel data available.</span>
        {% endif %}
      </div>
    </div>
  </div>

</div>


  </div>




<div class="col-md-6">
  <div class="card h-100">
    <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
  <i class="bi bi-clipboard-check me-2"></i>
  IPCR (Individual Performance Commitment and Review)
</h5>

      <form method="get" action="{{ url_for('homeHead') }}">
        <select name="period" class="form-select form-select-sm" onchange="this.form.submit()">
          {% for period in all_periods %}
            <option value="{{ period.id }}" {% if period.id == selected_period_id %}selected{% endif %}>
              {{ period.name }} 
            </option>
          {% endfor %}
        </select>
    </div>
    <div class="card-body table-responsive">
      <table class="table table-hover">
        <thead class="table-light">
          <tr>
            <th>Employee Name</th>
            <th>Score</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          {% for ipcr in ipcr_data %}
          <tr>
            <td>{{ ipcr.employee_name }}</td>
            <td>{{ ipcr.performance_score }}</td>
            <td>
              <span class="badge 
                {% if ipcr.status == 'Very Satisfactory' %}bg-success
                {% elif ipcr.status == 'Satisfactory' %}bg-info
                {% elif ipcr.status == 'Fair' %}bg-primary
                {% elif ipcr.status == 'Poor' %}bg-warning
                {% elif ipcr.status == 'Very Poor' %}bg-danger
                {% else %}bg-secondary{% endif %}">
                {{ ipcr.status }}
              </span>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="3" class="text-center">No graded IPCRs found for this period.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>


<div class="col-md-6 d-flex flex-column">
  <div class="card shadow-sm flex-grow-1">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
      <h5 class="mb-0 text-white">
        <i class="bi bi-file-earmark-spreadsheet me-2 text-white"></i>Requested Permits
      </h5>
      <span class="badge bg-white text-primary fw-semibold">{{ permit_requests|length }}</span>
    </div>

    <!-- Make body scrollable with fixed height -->
   <div class="card-body p-3 pb-4" style="max-height: 550px; overflow-y: auto;">

      {% if permit_requests %}
        {% for permit in permit_requests %}
          <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 text-capitalize fs-5">
                <i class="bi bi-file-earmark-text me-1 text-primary"></i>{{ permit.permit_type }}
              </h6>
              <span class="badge 
                {% if permit.status == 'Approved' %} bg-success
                {% elif permit.status == 'Pending' %} bg-warning text-dark
                {% elif permit.status == 'Released' %} bg-info
                {% elif permit.status == 'Rejected' %} bg-danger
                {% else %} bg-secondary {% endif %}">
                {{ permit.status }}
              </span>
            </div>
            <small class="text-muted">Requested on {{ permit.date_requested.strftime('%b %d, %Y') }}</small>

            <div class="mt-2 text-secondary small">
              {% if permit.permit_type == 'Leave' and permit.leave_detail %}
                <p class="mb-1"><strong>Leave Type:</strong> {{ permit.leave_detail.leave_type }}</p>
                <p class="mb-0"><strong>Duration:</strong> {{ permit.leave_detail.date_from }} to {{ permit.leave_detail.date_to }}</p>
              {% elif permit.permit_type == 'Travel Order' and permit.travel_detail %}
                <p class="mb-1"><strong>Destination:</strong> {{ permit.travel_detail.destination }}</p>
                <p class="mb-1"><strong>Departure:</strong> {{ permit.travel_detail.date_departure }}</p>
                <p class="mb-0"><strong>Purpose:</strong> {{ permit.travel_detail.purpose }}</p>
              {% elif permit.permit_type == 'Clearance Form' and permit.clearance_detail %}
                <p class="mb-1"><strong>Purpose:</strong> {{ permit.clearance_detail.clearance_purpose or permit.clearance_detail.other_purpose }}</p>
                <p class="mb-0"><strong>Duration:</strong> {{ permit.clearance_detail.date_from }} to {{ permit.clearance_detail.date_to }}</p>
              {% elif permit.permit_type == 'Certification of Employment' and permit.coe_detail %}
                <p class="mb-0">Request for Certificate of Employment.</p>
              {% else %}
                <p class="mb-0">No additional details available.</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4 text-muted">
          <i class="bi bi-exclamation-circle mb-2 fs-4"></i>
          <p class="mb-0">No permit requests found.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>


<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="eventModalBody">
        <!-- Content inserted dynamically -->
      </div>
    </div>
  </div>
</div>


<script>
  (function () {
    const url = new URL(window.location.href);
    if (url.searchParams.has('period')) {
      // Keep current view, pero alisin ang 'period' sa URL
      url.searchParams.delete('period');
      const qs = url.searchParams.toString();
      const clean = url.pathname + (qs ? '?' + qs : '');
      history.replaceState({}, '', clean);
    }
  })();
</script>

<!-- Calendar -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    // Helper: format datetime for input[type="datetime-local"]
    const toDatetimeLocal = (date) => {
      const pad = (n) => (n < 10 ? '0' + n : n);
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    // Reusable function to show modal
    const showModal = (title, body) => {
      document.getElementById('eventModalLabel').innerText = title;
      document.getElementById('eventModalBody').innerHTML = body;
      new bootstrap.Modal(document.getElementById('eventModal')).show();
    };

    const calendar = new FullCalendar.Calendar(calendarEl, {
      height: '100%',
  themeSystem: 'bootstrap5',
  initialView: 'dayGridMonth',
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
  },


   eventClassNames: function(arg) {
    return typeof arg.event.classNames === 'function'
      ? arg.event.classNames()
      : arg.event.classNames;
  },

  
  eventSources: [
    {
      url: '/admin/calendar-events',
      extraParams: { source: 'calendar' },
      color: '#3788d8'
    },
    {
      url: '/admin/interview-events',
      extraParams: { source: 'interview' },
      color: '#28a745'
    }
  ],

 

  eventClick: function (info) {
    const event = info.event;
    const props = event.extendedProps;

    const source = props.source;

    if (source === 'interview') {
        const dateOptions = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        };

        const formattedDate = event.start
          ? new Date(event.start).toLocaleString('en-US', dateOptions)
          : 'N/A';

        const content = `
           <div class="mb-4 text-center">
        <h4 class="fw-semibold text-primary mb-2">${event.title}</h4>
        <p class="text-muted mb-0">${formattedDate}</p>
      </div>

          <div class="mb-3">
            <h6 class="fw-bold fs-4 mb-1">Method</h6>
            <p class="text-muted fs-5 mb-3">${props.method || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Interviewer</h6>
            <p class="text-muted fs-5 mb-3">${props.interviewer || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Status</h6>
            <p class="text-muted fs-5 mb-3">${props.status || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Date and Time</h6>
            <p class="text-muted fs-5 ">${formattedDate}</p>
          </div>
        `;

        showModal('Interview Details', content);
      }
else {
  const dateOptionsFull = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  };

  const timeOnlyOptions = {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  };

  const startDate = event.start ? new Date(event.start) : null;
  const endDate = event.end ? new Date(event.end) : null;

  let formattedDateRange = startDate
    ? startDate.toLocaleString('en-US', dateOptionsFull)
    : 'N/A';

  if (startDate && endDate) {
    const isSameDay =
      startDate.getFullYear() === endDate.getFullYear() &&
      startDate.getMonth() === endDate.getMonth() &&
      startDate.getDate() === endDate.getDate();

    if (isSameDay) {
      const datePart = startDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const startTime = startDate.toLocaleString('en-US', timeOnlyOptions);
      const endTime = endDate.toLocaleString('en-US', timeOnlyOptions);
      formattedDateRange = `${datePart}, ${startTime} – ${endTime}`;
    } else {
      const formattedStart = startDate.toLocaleString('en-US', dateOptionsFull);
      const formattedEnd = endDate.toLocaleString('en-US', dateOptionsFull);
      formattedDateRange = `${formattedStart} – ${formattedEnd}`;
    }
  }

  const content = `
    <div class="mb-4 text-center">
      <h4 class="fw-semibold text-primary mb-2">${event.title}</h4>
      <p class="text-muted mb-0">${formattedDateRange}</p>
    </div>

    <div class="mb-3">
      <h6 class="fw-bold fs-4 mb-1">Event Type</h6>
      <p class="text-muted fs-5 mb-3">${props.label || 'N/A'}</p>
      <hr>
      <h6 class="fw-bold fs-4 mb-1">Description / Location</h6>
      <p class="text-muted fs-5 mb-3">${props.location || 'N/A'}</p>
      <hr>
      <h6 class="fw-bold fs-4 mb-1">Date and Time</h6>
      <p class="text-muted fs-5">${formattedDateRange}</p>
    </div>
  `;

  showModal('', content);
}



  }
});


    calendar.render();
  });
</script>

<script id="employeeCounts" type="application/json">
  {{ {
    "permanent": permanent_count | default(0),
    "casual": casual_count | default(0),
    "jobOrder": job_order_count | default(0)
  } | tojson }}
</script>

<!-- EMPLOYEE COUNT -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const employeeCountsScript = document.getElementById('employeeCounts');
    let employeeCounts = { permanent: 0, casual: 0, jobOrder: 0 };

    try {
      employeeCounts = JSON.parse(employeeCountsScript.textContent);
    } catch (e) {
      console.warn('Failed to parse employee counts JSON:', e);
    }

    const totalEmployees = 
      employeeCounts.permanent + 
      employeeCounts.casual + 
      employeeCounts.jobOrder;

    const options = {
      chart: {
        type: 'donut',
        height: 250,
      },
      labels: ['Permanent', 'Casual', 'Job Order'],
      series: [
        employeeCounts.permanent,
        employeeCounts.casual,
        employeeCounts.jobOrder
      ],
      colors: ['#7367F0', '#28C76F', '#00CFE8'],
      legend: {
        position: 'bottom',
        fontSize: '12px',
        markers: {
          width: 10,
          height: 10
        }
      },
      tooltip: {
        y: {
          formatter: function (val) {
            return val + " employees";
          }
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function (val) {
          return val.toFixed(1) + '%';
        },
        style: {
          fontSize: '12px'
        }
      },
      plotOptions: {
        pie: {
          donut: {
            size: '65%',
            labels: {
              show: true,
              name: {
                show: true,
                fontSize: '12px',
                fontWeight: 300,
                offsetY: -10
              },
              value: {
                show: true,
                fontSize: '18px',
                fontWeight: 600,
                offsetY: 10,
                formatter: function (val) {
                  return parseInt(val) ;
                }
              },
              total: {
                show: true,
                label: 'Total Employees',
                fontSize: '14px',
                fontWeight: 300,
                color: '#999',
                offsetY: -30,
                formatter: function () {
                  return totalEmployees.toString();
                }
              }
            }
          }
        }
      }
    };

    const chart = new ApexCharts(document.querySelector("#employeeChart"), options);
    chart.render();
  });
</script>

<!-- progress -->
<!-- IPCR PROGRESS CHART -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const graded = JSON.parse('{{ ipcr_total_submitted | default(0) | tojson }}');           
  const submittedNotGraded = JSON.parse('{{ submitted_only_ipcr | default(0) | tojson }}'); 
  const total = JSON.parse('{{ ipcr_total_expected | default(0) | tojson }}');             

  const remaining = Math.max(total - (graded + submittedNotGraded), 0);

  const options = {
    chart: {
      type: 'donut',
      height: 250
    },
    series: [graded, submittedNotGraded, remaining],
    labels: ['Graded', 'Submitted', 'Remaining'],
    colors: ['#28C76F', '#FF9F43', '#ADB5BD'],
    legend: {
      position: 'bottom',
      fontSize: '12px',
      markers: { width: 10, height: 10 }
    },
    tooltip: {
      y: {
        formatter: function(val) {
          return val + " employees";
        }
      }
    },
    dataLabels: {
      enabled: true,
      formatter: function(val) { return val.toFixed(1) + '%'; },
      style: { fontSize: '12px' }
    },
    plotOptions: {
      pie: {
        donut: {
          size: '65%',
          labels: {
            show: true,
            name: {
              show: true,
              fontSize: '12px',
              fontWeight: 300,
              offsetY: -10
            },
            value: {
              show: true,
              fontSize: '18px',
              fontWeight: 600,
              offsetY: 10,
              formatter: function(val) {
                return parseInt(val);
              }
            },
            total: {
              show: true,
              label: 'Submitted',
              fontSize: '14px',
              fontWeight: 300,
              color: '#999',
              offsetY: -30,
              formatter: function() {
                return (graded + submittedNotGraded).toString();
              }
            }
          }
        }
      }
    }
  };

  const chart = new ApexCharts(document.querySelector("#deptIPCRChart"), options);
  chart.render();
});
</script>


{% endblock content %}