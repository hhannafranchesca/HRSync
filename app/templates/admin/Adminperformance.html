{% extends "base/AdminDashboard.html" %}
{% block content %}

  <div class="card h-100 min-vh-100 d-flex flex-column">
    <div class="card-header border-bottom">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <h5 class="card-title mb-0">Employee IPCR</h5>
        <!-- Export Button -->
        <div class="btn-group">
          <button class="btn btn-outline-secondary dropdown-toggle d-flex align-items-center"
                  type="button"
                  id="exportDropdown"
                  data-bs-toggle="dropdown"
                  aria-expanded="false">
            <i class="bi bi-box-arrow-up me-1"></i>
            <span>Export</span>
          </button>
          <ul class="dropdown-menu" aria-labelledby="exportDropdown">
            <!-- Uncomment if needed:
            <li><a class="dropdown-item" href="#"><i class="bi bi-filetype-csv me-2"></i>Export as CSV</a></li>
            <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-spreadsheet me-2"></i>Export as Excel</a></li>
            -->
        <li>
  <a class="dropdown-item" href="{{ url_for('generate_headdept_ipcr_employee_pdf') }}?period_filter={{ selected_period.id if selected_period else '' }}">
    <i class="bi bi-file-pdf me-2"></i>Export as PDF
  </a>
</li>

            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item" 
   href="{{ url_for('print_headdept_ipcr_employee') }}?period_filter={{ selected_period.id if selected_period else '' }}" 
   target="_blank">
  <i class="bi bi-printer me-2"></i>Print
</a>

            </li>
          </ul>
        </div>
      </div>

      <!-- Filters -->
      <div class="row pt-4 g-3 align-items-end">

        <!-- Evaluation Period -->
        <div class="col-md-6">
          <label for="period_filter" class="form-label">Select Evaluation Period</label>
          <select class="form-select" name="period_filter" id="period_filter">
            {% for period in periods %}
              <option value="{{ period.id }}"
                {% if selected_period and selected_period.id == period.id %}selected{% endif %}>
                {{ period.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Grade Status -->
        <div class="col-md-6">
          <label for="grade_status_filter" class="form-label">Select Grade Status</label>
          <select id="grade_status_filter" class="form-select text-capitalize">
            <option value="">All Status</option>
            <option value="graded">Graded</option>
            <option value="not_graded">Not Graded</option>
            <option value="no_ipcr">Not Submitted</option>
          </select>
        </div>

      </div>
    </div>

<div class="card-datable pt-4 pb-2 px-4">

      <div class="dt-layout-table">
        <div class="table-responsive">
          <table class="table table-bordered align-middle border-top" id="DataTables_Table_0" style="width: 100%;">
            <thead class="table-dark align-middle text-center">
              <tr>
                <th>Employee Name</th>
                <th>Position</th>
                <th>Status</th>
                <th>Graded</th>
                <th>Date Submitted</th>
                <th>Submission Status</th>
                <th>Overall Grade</th>
                <th>Action</th>
              </tr>
            </thead>

            <tbody>
              {% for entry in employee_ipcr_status %}
                {% set emp = entry.employee %}
                {% set ipcr = entry.ipcr %}
               <tr class="text-center"
        data-grade-status="{% if not ipcr %}no_ipcr{% elif ipcr.graded %}graded{% elif not ipcr.submitted %}no_ipcr{% else %}not_graded{% endif %}"
        data-submission-status="{% if not ipcr %}no_ipcr{% elif ipcr.late_submission %}late{% elif ipcr.submitted %}on_time{% else %}not_submitted{% endif %}">

                  <td>{{ emp.first_name }} {{ emp.last_name }}</td>

                  <td>
                    {% if emp.permanent_details %}
                      {{ emp.permanent_details.position.title }}
                    {% elif emp.casual_details %}
                      {{ emp.casual_details.position.title }}
                    {% elif emp.job_order_details %}
                      {{ emp.job_order_details.position_title }}
                    {% else %}
                      Unknown
                    {% endif %}
                  </td>

                  <td>
                    {% if ipcr %}
                      {% if not ipcr.submitted and not ipcr.graded %}
                        <span class="badge bg-warning text-dark">Returned</span>
                      {% elif ipcr.submitted %}
                        <span class="badge bg-success">Submitted</span>
                      {% else %}
                        <span class="badge bg-secondary">Draft</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-secondary">No IPCR</span>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    {% if ipcr %}
                      {% if ipcr.graded %}
                        <span class="badge bg-label-success">Graded</span>
                      {% elif not ipcr.submitted %}
                        <span class="badge bg-label-warning text-dark">Not Submitted</span>
                      {% else %}
                        <span class="badge bg-label-danger">Not Graded</span>
                      {% endif %}
                    {% else %}
                      <span class="badge bg-label-secondary">Not Submitted</span>
                    {% endif %}
                  </td>


                  <td class="text-center">
                    {% if ipcr and ipcr.date_submitted %}
                      {{ ipcr.date_submitted | ph_time_exact }}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>

                  <td class="text-center">
                    {% if ipcr and ipcr.date_submitted %}
                      {% if ipcr.late_submission %}
                        <span class="badge border border-danger text-danger">Late</span>
                      {% else %}
                        <span class="badge border border-success text-success">On Time</span>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>


                  <td>
                    {% if ipcr and ipcr.graded %}
                      {{ ipcr.final_average_rating or '0' }}
                    {% else %}
                      0
                    {% endif %}
                  </td>

                  <td>
                    {% if ipcr %}
                      {% if ipcr.graded %}
                        <a href="{{ url_for('HeadViewIpcr', ipcr_id=ipcr.id) }}" class="btn btn-primary btn-sm">
                          <i class="fas fa-eye"></i> View
                        </a>
                      {% elif selected_period and active_period and selected_period.id == active_period.id %}
                        {% if ipcr.submitted %}
                          <a href="{{ url_for('HeadGradeIpcr', ipcr_id=ipcr.id) }}" class="btn btn-warning btn-sm">
                            <i class="fas fa-pen"></i> Rate
                          </a>
                        {% else %}
                          <span class="text-warning">Returned</span>
                        {% endif %}
                      {% else %}
                        {% if not ipcr.submitted %}
                          <span class="text-warning">Returned</span>
                        {% endif %}
                      {% endif %}
                    {% else %}
                      <span class="text-muted">No IPCR</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>


{% block scripts %}
<script>
$(document).ready(function () {
  $('#DataTables_Table_0').css({'table-layout': 'fixed','width': '100%'});

  var ipcrTable = $('#DataTables_Table_0').DataTable({
    paging: true,
    searching: true,
    ordering: true,
    responsive: true,
    autoWidth: false,
    pageLength: 10,
    lengthMenu: [5, 10, 25, 50, 100],
    columnDefs: [
      { targets: 0, width: "18%", className: "text-start" },
      { targets: 1, width: "13%", className: "text-start" },
      { targets: 2, width: "10%", className: "text-center" },
      { targets: 3, width: "10%", className: "text-center" },
      { targets: 4, width: "13%", className: "text-center" },
      { targets: 5, width: "10%", className: "text-center" },
      { targets: 6, width: "8%",  className: "text-center" },
      { targets: 7, width: "18%", orderable: false, className: "text-center" }
    ],
    dom: '<"row mb-3"<"col-md-6 d-flex align-items-center"f><"col-md-6 text-end"l>>' +
         't' +
         '<"row mt-3"<"col-md-6"i><"col-md-6 text-end"p>>',
    language: { search: "", searchPlaceholder: "Search employees..." }
  });

  // style inputs
  $(".dataTables_filter input").addClass("form-control form-control-lg w-auto").css("margin-left", "0");
  $(".dataTables_length select").addClass("form-select form-select-lg").css("min-width", "80px");

  // Filter by grade status (client-side)
  $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
    var selectedStatus = $('#grade_status_filter').val();
    // read attr explicitly (avoid hyphen-to-camel mismatch)
    var rowNode = ipcrTable.row(dataIndex).node();
    var rowStatus = rowNode ? $(rowNode).attr('data-grade-status') : undefined;

    // DEBUG: uncomment when debugging. Keeps console informative.
    // console.log('rowStatus:', rowStatus, 'selectedStatus:', selectedStatus);

    if (!selectedStatus) return true; // show all if no filter selected
    return String(rowStatus) === String(selectedStatus);
  });

  $('#grade_status_filter').on('change', function() {
    ipcrTable.draw();
  });

  // Period reload (unchanged)
  $('#period_filter').on('change', function() {
    const periodId = $(this).val();
    const url = new URL(window.location.href);
    url.searchParams.set('period_id', periodId);
    window.location.href = url.toString();
  });
});
</script>
{% endblock %}


{% endblock content %}
