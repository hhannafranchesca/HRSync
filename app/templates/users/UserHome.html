{% extends "base/UserDashboard.html" %}

{% block content %}


<style>
   
/* Calendar container */
#calendar {
  font-size: 0.9rem;
  background-color: #fff;
  border-radius: 0.75rem;
  padding: 1.5rem;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.03);
}

.fc .fc-toolbar-title {
  font-size: 1.3rem; /* or 24px */
  font-weight: bold;
}

/* Calendar buttons */
.fc .fc-button {
  background-color: #1f2937; /* Gray-800 */
  color: #fff;
  border: none;
  font-size: 0.9rem;
  padding: 0.45rem 0.9rem;
  margin: 0 2px;
  border-radius: 0.375rem;
  text-transform: capitalize;
  transition: all 0.2s ease-in-out;
}



/* Month & general views */
.fc-event {
  border-radius: 0.5rem;
  padding: 1px 8px;
  font-size: 0.975rem;
  font-weight: 500;
  border: 1px solid #cbd5e1;
  color: #fff !important;
  background-color: #6c757d; /* fallback default */
  transition: all 0.2s ease-in-out;
  cursor: pointer;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
}
.fc .fc-toolbar-chunk .fc-today-button {
  margin-left: 20px;   /* space sa gilid */
  margin-top: 4px;    /* dagdag space sa taas */
}

/* Week/Day view (timeGrid) */
.fc-timegrid-event-harness .fc-event,
.fc-timegrid-event .fc-event-main {
  color: #fff !important;
  background-color: inherit !important;
  border: none !important;
}

/* List view */
.fc-list-event {
  background-color: inherit !important;
  border-left: 4px solid currentColor;
}
.fc-list-event .fc-event-title,
.fc-list-event-title {
  color: #fff !important;
}

/* Hover */
.fc-event:hover {
  opacity: 0.95;
  transform: scale(1.02);
  box-shadow: 0 4px 8px rgba(0,0,0,0.12);
  z-index: 10;
}

/* Label colors - readable text for light backgrounds */
.fc-event.fc-primary, .fc-primary {
  background-color: #dbeafe !important;
  color: #1d4ed8 !important;
}
.fc-event.fc-success, .fc-success {
  background-color: #dcfce7 !important;
  color: #15803d !important;
}
.fc-event.fc-danger, .fc-danger {
  background-color: #fee2e2 !important;
  color: #b91c1c !important;
}
.fc-event.fc-warning, .fc-warning {
  background-color: #fef3c7 !important;
  color: #92400e !important;
}
.fc-event.fc-info-solid, .fc-info-solid {
  background-color: #cffafe !important;
  color: #0369a1 !important;
}
.fc-event.fc-warning-solid, .fc-warning-solid {
  background-color: #fef9c3 !important;
  color: #78350f !important;
}
.fc-event.fc-primary-solid, .fc-primary-solid {
  background-color: #e0f2fe !important;
  color: #1e3a8a !important;
}
.fc-event.fc-default, .fc-default {
  background-color: #f3f4f6 !important;
  color: #374151 !important;
}
/* Apply text color directly inside event content */
.fc-event .fc-event-title,
.fc-event .fc-event-time,
.fc-event .fc-event-main {
  color: inherit !important;
}
/* Remove event border */
.fc-event {
  border: none !important;
  box-shadow: none !important;
}

.fc .fc-list-event:hover td {
  background-color: rgba(0, 0, 0, 0.05) !important; /* subtle dark */
}
/* Make FullCalendar toolbar responsive */
@media (max-width: 768px) {
  .fc .fc-toolbar {
    flex-direction: column !important;
    align-items: center !important;
    gap: 0.5rem;
  }

  .fc .fc-toolbar-chunk {
    width: 100%;
    display: flex;
    justify-content: center;
    flex-wrap: wrap; /* para hindi dikit yung buttons */
    gap: 0.25rem;
  }

  .fc .fc-toolbar-title {
    font-size: 1rem; /* paliitin yung title sa mobile */
    text-align: center;
  }
}
</style>

<div class="row g-4 ">

{% if not current_user.employee.job_order_details %}
  {% if ipcr_submission_open %}
    <div class="col-12 mt-4">
      {% if ipcr_status == "none" %}
        <!-- New Submission -->
        <div class="card border-0 shadow-sm rounded-4 bg-light">
          <div class="card-body text-center p-5">
            <div class="mb-3">
              <i class="bi bi-file-earmark-check-fill fs-1 text-primary"></i>
            </div>
            <h4 class="card-title text-primary mb-2">IPCR Submission Now Open</h4>
            <p class="card-text text-muted fs-6">You may now submit your IPCR for this evaluation period.</p>
            <a href="{{ url_for('EmployeeSubmitIPCR') }}" class="btn btn-lg btn-primary px-4">
              <i class="bi bi-upload me-2"></i> Submit IPCR
            </a>
          </div>
        </div>

      {% elif ipcr_status == "returned" %}
        <!-- Returned (Not Submitted, Not Graded) -->
        <div class="card border-0 shadow-sm rounded-4 bg-warning-subtle">
          <div class="card-body text-center p-5">
            <div class="mb-3">
              <i class="bi bi-arrow-counterclockwise fs-1 text-warning" style="font-size: 3rem;"></i>
            </div>
            <h4 class="card-title text-warning mb-2">IPCR Returned</h4>
            <p class="card-text text-muted mb-4 fs-6">
              Your submitted <strong>IPCR</strong> has been returned by your head for revision. Please make the necessary updates and resubmit.
            </p>
            <a href="{{ url_for('EmployeeSubmitIPCR') }}" class="btn btn-lg btn-warning px-4">
              <i class="bi bi-upload me-2"></i> Resubmit IPCR
            </a>
          </div>
        </div>

      {% elif ipcr_status == "submitted" %}
        <!-- Submitted -->
        <div class="card border-0 shadow-sm rounded-4 bg-primary-subtle">
          <div class="card-body text-center p-5">
            <div class="mb-3">
              <i class="bi bi-check-circle-fill fs-1 text-primary"></i>
            </div>
            <h4 class="card-title text-primary mb-2">IPCR Submitted</h4>
            <p class="card-text text-muted fs-6">Your IPCR has been submitted and is awaiting grading.</p>
          </div>
        </div>

      {% elif ipcr_status == "graded" %}
        <!-- Graded -->
        <div class="card border-0 shadow-sm rounded-4 bg-success-subtle">
          <div class="card-body text-center p-5">
            <div class="mb-3">
              <i class="bi bi-star-fill fs-1 text-success"></i>
            </div>
            <h4 class="card-title text-success mb-2">IPCR Graded</h4>
            <p class="card-text text-muted fs-6">Your IPCR has been reviewed and graded. You may view the results.</p>
          </div>
        </div>

      {% endif %}
    </div>
  {% endif %}
{% endif %}


  <!-- FULL-WIDTH STATIC USER INFO CARD -->
  <div class="{% if current_user.employee.job_order_details %}col-12{% else %}col-8{% endif %}">
  <div class="card shadow-sm border-0 rounded-4 p-3" style="min-height: 160px;">
      <div class="card-body d-flex flex-column flex-md-row align-items-center justify-content-between gap-3">
        
        <!-- Avatar & Info -->
        <div class="d-flex align-items-center gap-3 flex-grow-1">
          <img
            src="{{ url_for('static', filename='img/avatars/' ~ current_user.image_file) if current_user.image_file and current_user.image_file != 'default.jpg' else url_for('static', filename='img/avatars/default.png') }}"
            alt="User Avatar"
            class="rounded-circle border border-2 border-primary flex-shrink-0"
            width="100"
            height="100"
          />
          <div class="flex-grow-1">
            <h4 class="mb-1 fw-bold">{{ current_user.employee.last_name }}, {{ current_user.employee.first_name }} {{ current_user.employee.middle_name[0] }}.</h4>
            <p class="mb-1 text-muted">{{ current_user.email }}</p>
            <div class="d-flex flex-wrap gap-2">
              <!-- Position -->
              <span class="badge bg-primary px-3 py-2">
                {% if current_user.employee %}
                  {% if current_user.employee.permanent_details %}
                    {{ current_user.employee.permanent_details.position.title }}
                  {% elif current_user.employee.casual_details %}
                    {{ current_user.employee.casual_details.position.title }}
                  {% elif current_user.employee.job_order_details %}
                    {{ current_user.employee.job_order_details.position_title }}
                  {% else %}
                    No Position
                  {% endif %}
                {% else %}
                  No Position
                {% endif %}
              </span>
              <!-- Department -->
              <span class="badge bg-secondary px-3 py-2">
                {% if current_user.employee %}
                  {% if current_user.employee.casual_details and current_user.employee.casual_details.assigned_department %}
                    {{ current_user.employee.casual_details.assigned_department.name }}
                  {% elif current_user.employee.job_order_details and current_user.employee.job_order_details.assigned_department %}
                    {{ current_user.employee.job_order_details.assigned_department.name }}
                  {% elif current_user.employee.department %}
                    {{ current_user.employee.department.name }}
                  {% else %}
                    No Department
                  {% endif %}
                {% else %}
                  No Department
                {% endif %}
              </span>
            </div>
          </div>
        </div>

        <!-- Edit Profile Button -->
        <div class="mt-3 mt-md-0 text-center text-md-end">
          <a href="{{ url_for('employeeaccount') }}" class="btn btn-outline-primary btn-lg">
            <i class="bi bi-pencil me-1"></i> Edit Profile
          </a>
        </div>

      </div>
    </div>
  </div>

  {% if not current_user.employee.job_order_details %}
  <!-- Credit Balance Card -->
  <div class="col-12 col-md-4">
    <div class="card shadow-sm border-0 rounded-4 h-100">
      <div class="card-body d-flex flex-column">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="fw-semibold mb-0">
            <i class="bi bi-wallet2 me-2 text-primary"></i> Credit Balance
          </h6>
        </div>

        {% if current_user.employee.credit_balance %}
        <div class="row g-3 mb-2">
          <div class="col-6">
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                <i class="bi bi-sun-fill fs-5"></i>
              </div>
              <div>
                <div class="fw-semibold text-primary small">Vacation Leave</div>
                <div class="fs-5 fw-bold">{{ current_user.employee.credit_balance.vacation_remaining }}</div>
                <small class="text-muted">days left</small>
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="d-flex align-items-center gap-2">
              <div class="rounded-circle bg-info text-white d-flex align-items-center justify-content-center" style="width: 42px; height: 42px;">
                <i class="bi bi-heart-pulse-fill fs-5"></i>
              </div>
              <div>
                <div class="fw-semibold text-info small">Sick Leave</div>
                <div class="fs-5 fw-bold">{{ current_user.employee.credit_balance.sick_remaining }}</div>
                <small class="text-muted">days left</small>
              </div>
            </div>
          </div>
        </div>

        <div class="text-muted small mt-auto text-start">
          <i class="bi bi-clock-history me-1"></i>
          Last updated: {{ current_user.employee.credit_balance.last_updated.strftime('%b %d, %Y %I:%M %p') }}
        </div>
        {% else %}
          <div class="text-muted fst-italic">No credit record available.</div>
        {% endif %}
      </div>
    </div>
  </div>
  {% endif %}


  <!-- RIGHT COLUMN (Calendar) -->
   <div class="col-md-6">
    <div class="card h-100" style="min-height: 690px;">
      <div class="card-header d-flex justify-content-between align-items-center pb-0">
      <h5 class="mb-0">
  <i class="bi bi-calendar3 me-2"></i>Schedule Calendar
</h5>

      </div>
      <div class="card-body pt-3">
        <div id="calendar" class="mt-2"></div>
      </div>
    </div>
  </div>

  <!-- REQUESTED PERMITS COLUMN -->
<!-- REQUESTED PERMITS COLUMN -->
<div class="col-md-6 d-flex flex-column">
  <div class="card shadow-sm flex-grow-1">
    <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
      <h5 class="mb-0 text-white">
        <i class="bi bi-file-earmark-spreadsheet me-2 text-white"></i>Requested Permits
      </h5>
      <span class="badge bg-white text-primary fw-semibold">{{ permit_requests|length }}</span>
    </div>
    
    <!-- Add scroll wrapper here -->
    <div class="card-body p-3 pb-4" style="max-height: 580px; overflow-y: auto;">
      {% if permit_requests %}
        {% for permit in permit_requests %}
          <div class="border rounded p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0 text-capitalize fs-5">
                <i class="bi bi-file-earmark-text me-1 text-primary"></i>{{ permit.permit_type }}
              </h6>
              <span class="badge 
                {% if permit.status == 'Approved' %} bg-success
                {% elif permit.status == 'Pending' %} bg-warning text-dark
                {% elif permit.status == 'Released' %} bg-info
                {% elif permit.status == 'Rejected' %} bg-danger
                {% else %} bg-secondary {% endif %}">
                {{ permit.status }}
              </span>
            </div>
            <small class="text-muted">Requested on {{ permit.date_requested.strftime('%b %d, %Y') }}</small>

            <div class="mt-2 text-secondary small">
              {% if permit.permit_type == 'Leave' and permit.leave_detail %}
                <p class="mb-1"><strong>Leave Type:</strong> {{ permit.leave_detail.leave_type }}</p>
                <p class="mb-0"><strong>Duration:</strong> {{ permit.leave_detail.date_from }} to {{ permit.leave_detail.date_to }}</p>
              {% elif permit.permit_type == 'Travel Order' and permit.travel_detail %}
                <p class="mb-1"><strong>Destination:</strong> {{ permit.travel_detail.destination }}</p>
                <p class="mb-1"><strong>Departure:</strong> {{ permit.travel_detail.date_departure }}</p>
                <p class="mb-0"><strong>Purpose:</strong> {{ permit.travel_detail.purpose }}</p>
              {% elif permit.permit_type == 'Clearance Form' and permit.clearance_detail %}
                <p class="mb-1"><strong>Purpose:</strong> {{ permit.clearance_detail.clearance_purpose or permit.clearance_detail.other_purpose }}</p>
                <p class="mb-0"><strong>Duration:</strong> {{ permit.clearance_detail.date_from }} to {{ permit.clearance_detail.date_to }}</p>
              {% elif permit.permit_type == 'Certification of Employment' and permit.coe_detail %}
                <p class="mb-0">Request for Certificate of Employment.</p>
              {% else %}
                <p class="mb-0">No additional details available.</p>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-center py-4 text-muted">
          <i class="bi bi-exclamation-circle mb-2 fs-4"></i>
          <p class="mb-0">No permit requests found.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% if not current_user.employee.job_order_details %}
  <!-- LEFT: Performance Trend -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="bi bi-graph-up me-2"></i>Performance Trend
        </h4>
      </div>
      <div class="card-body">
        <div id="ipcr-performance-chart"></div>
        <!-- Custom Legend -->
        <div id="custom-legend" class="d-flex flex-wrap justify-content-center gap-2 mt-3"></div>
      </div>
    </div>
  </div>

  <!-- RIGHT: IPCR QETA Performance -->
  <div class="col-md-6">
    <div class="card h-100">
      <div class="card-header">
        <h4 class="mb-0">
          <i class="bi bi-bar-chart-line me-2"></i>IPCR QETA Performance
        </h4>
      </div>
      <div class="card-body">
        <div id="ipcr-chart-mfo"></div>
      </div>
    </div>
  </div>



<div class="col-12">
  <div class="card">
    <div class="card-header">
      <h4 class="mb-0">
        <i class="bi bi-clipboard-check me-2"></i>Performance Feedback Summary
      </h4>
    </div>

    <div class="card-body">
      {% if ai_summary or ai_suggestions or ai_training_recommendations %}
        <div class="row g-4">
          {% if ai_summary %}
          <div class="col-md-12">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="text-primary fw-bold mb-3">
                  <i class="bi bi-chat-left-text me-2"></i>Summary
                </h5>
                <p class="mb-0">{{ ai_summary }}</p>
              </div>
            </div>
          </div>
          {% endif %}

          {% if ai_suggestions %}
          <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="text-primary fw-bold mb-3">
                  <i class="bi bi-lightbulb me-2"></i>Suggestions for Improvement
                </h5>
                <ul class="list-group list-group-flush">
                  {% for suggestion in ai_suggestions %}
                  <li class="list-group-item">
                    <i class="bi bi-check-circle-fill text-info me-2"></i>{{ suggestion }}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endif %}

          {% if ai_training_recommendations %}
          <div class="col-md-6">
            <div class="card h-100 shadow-sm border-0">
              <div class="card-body">
                <h5 class="text-primary fw-bold mb-3">
                  <i class="bi bi-journal-medical me-2"></i>Recommended Trainings & Certifications
                </h5>
                <ul class="list-group list-group-flush">
                  {% for training in ai_training_recommendations %}
                  <li class="list-group-item">
                    <i class="bi bi-award-fill text-success me-2"></i>{{ training }}
                  </li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      {% else %}
        <div class="text-center my-5">
          <h5>No AI insights available for this employee.</h5>
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endif %}


<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="eventModalBody">
        <!-- Content inserted dynamically -->
      </div>
    </div>
  </div>
</div>


<!-- Calendar -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    // Helper: format datetime for input[type="datetime-local"]
    const toDatetimeLocal = (date) => {
      const pad = (n) => (n < 10 ? '0' + n : n);
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    // Reusable function to show modal
    const showModal = (title, body) => {
      document.getElementById('eventModalLabel').innerText = title;
      document.getElementById('eventModalBody').innerHTML = body;
      new bootstrap.Modal(document.getElementById('eventModal')).show();
    };

    const calendar = new FullCalendar.Calendar(calendarEl, {
      height: '100%',
  themeSystem: 'bootstrap5',
  initialView: 'dayGridMonth',
  headerToolbar: {
    left: 'prev,next today',
    center: 'title',
    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
  },


   eventClassNames: function(arg) {
    return typeof arg.event.classNames === 'function'
      ? arg.event.classNames()
      : arg.event.classNames;
  },

  
  eventSources: [
    {
      url: '/admin/calendar-events',
      extraParams: { source: 'calendar' },
      color: '#3788d8'
    },
    {
      url: '/admin/interview-events',
      extraParams: { source: 'interview' },
      color: '#28a745'
    }
  ],

 

  eventClick: function (info) {
    const event = info.event;
    const props = event.extendedProps;

    const source = props.source;

    if (source === 'interview') {
        const dateOptions = {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        };

        const formattedDate = event.start
          ? new Date(event.start).toLocaleString('en-US', dateOptions)
          : 'N/A';

        const content = `
           <div class="mb-4 text-center">
        <h4 class="fw-semibold text-primary mb-2">${event.title}</h4>
        <p class="text-muted mb-0">${formattedDate}</p>
      </div>

          <div class="mb-3">
            <h6 class="fw-bold fs-4 mb-1">Method</h6>
            <p class="text-muted fs-5 mb-3">${props.method || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Interviewer</h6>
            <p class="text-muted fs-5 mb-3">${props.interviewer || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Status</h6>
            <p class="text-muted fs-5 mb-3">${props.status || 'N/A'}</p>
            <hr>
            <h6 class="fw-bold fs-4 mb-1">Date and Time</h6>
            <p class="text-muted fs-5 ">${formattedDate}</p>
          </div>
        `;

        showModal('Interview Details', content);
      }
else {
  const dateOptionsFull = {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  };

  const timeOnlyOptions = {
    hour: 'numeric',
    minute: '2-digit',
    hour12: true
  };

  const startDate = event.start ? new Date(event.start) : null;
  const endDate = event.end ? new Date(event.end) : null;

  let formattedDateRange = startDate
    ? startDate.toLocaleString('en-US', dateOptionsFull)
    : 'N/A';

  if (startDate && endDate) {
    const isSameDay =
      startDate.getFullYear() === endDate.getFullYear() &&
      startDate.getMonth() === endDate.getMonth() &&
      startDate.getDate() === endDate.getDate();

    if (isSameDay) {
      const datePart = startDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      const startTime = startDate.toLocaleString('en-US', timeOnlyOptions);
      const endTime = endDate.toLocaleString('en-US', timeOnlyOptions);
      formattedDateRange = `${datePart}, ${startTime} – ${endTime}`;
    } else {
      const formattedStart = startDate.toLocaleString('en-US', dateOptionsFull);
      const formattedEnd = endDate.toLocaleString('en-US', dateOptionsFull);
      formattedDateRange = `${formattedStart} – ${formattedEnd}`;
    }
  }

  const content = `
    <div class="mb-4 text-center">
      <h4 class="fw-semibold text-primary mb-2">${event.title}</h4>
      <p class="text-muted mb-0">${formattedDateRange}</p>
    </div>

    <div class="mb-3">
      <h6 class="fw-bold fs-4 mb-1">Event Type</h6>
      <p class="text-muted fs-5 mb-3">${props.label || 'N/A'}</p>
      <hr>
      <h6 class="fw-bold fs-4 mb-1">Description / Location</h6>
      <p class="text-muted fs-5 mb-3">${props.location || 'N/A'}</p>
      <hr>
      <h6 class="fw-bold fs-4 mb-1">Date and Time</h6>
      <p class="text-muted fs-5">${formattedDateRange}</p>
    </div>
  `;

  showModal('', content);
}



  }
});


    calendar.render();
  });
</script>



<!-- Chart Data -->
<script id="chart-data" type="application/json">
  {{ chart_data | tojson }}
</script>

<!-- Script -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const chartDataElement = document.getElementById("chart-data");
    if (!chartDataElement) return;

    const rawData = JSON.parse(chartDataElement.textContent);

    // Step 1: Group ratings by period
    const periodRatings = {};
    rawData.forEach(entry => {
      if (!periodRatings[entry.period]) {
        periodRatings[entry.period] = [];
      }
      periodRatings[entry.period].push(entry.rating_a);
    });

    // Step 2: Compute averages with associated color category
    const dataWithColors = [];
    Object.entries(periodRatings).forEach(([period, values]) => {
      const validValues = values.filter(v => v !== null);
      const average = validValues.length ? (validValues.reduce((a, b) => a + b, 0) / validValues.length) : null;

      let category = "none", color;
      if (average === null) {
        category = "none";
        color = '#adb5bd';
      } else if (average >= 4.5) {
        category = "very_satisfactory";
        color = '#28a745';
      } else if (average >= 4.0) {
        category = "satisfactory";
        color = '#0d6efd';
      } else if (average >= 3.5) {
        category = "fair";
        color = '#FFC107';
      } else if (average >= 3.0) {
        category = "poor";
        color = '#fd7e14';
      } else {
        category = "very_poor";
        color = '#dc3545';
      }

      dataWithColors.push({
        x: period,
        y: average ?? 0,
        fillColor: color,
        category: category
      });
    });

    // Store original data
    let filteredData = [...dataWithColors];

    // Step 3: ApexCharts options
    const chartOptions = {
      chart: {
        type: 'bar',
        height: 350,
        toolbar: { show: false },
        animations: { enabled: true }
      },
      series: [{
        name: 'Average Rating (A)',
        data: filteredData
      }],
      xaxis: {
        title: { text: 'Evaluation Period' },
        labels: { rotate: -45 }
      },
      yaxis: {
        min: 0,
        max: 5,
        title: { text: 'Adjectival Rating' }
      },
      dataLabels: {
        enabled: true,
        formatter: function (val) {
          return val ? val.toFixed(2) : "-";
        }
      },
      plotOptions: {
        bar: {
          borderRadius: 5,
          columnWidth: '50%'
        }
      },
      legend: {
        show: false
      }
    };

    const chartEl = document.querySelector("#ipcr-performance-chart");
    const chart = new ApexCharts(chartEl, chartOptions);
    chart.render();

    // Step 4: Clickable legend logic
    const legendItems = [
      { label: "Very Satisfactory (4.5–5.0)", color: "#28a745", key: "very_satisfactory" },
      { label: "Satisfactory (4.0–4.49)", color: "#0d6efd", key: "satisfactory" },
      { label: "Fair (3.5–3.99)", color: "#FFC107", key: "fair" },
      { label: "Poor (3.0–3.49)", color: "#fd7e14", key: "poor" },
      { label: "Very Poor (<3.0)", color: "#dc3545", key: "very_poor" }
    ];

    const activeCategories = new Set(legendItems.map(item => item.key)); // Initially all visible

    function renderLegend() {
      const container = document.getElementById("custom-legend");
      container.innerHTML = "";

      legendItems.forEach(item => {
        const legend = document.createElement("span");
        legend.className = "d-inline-flex align-items-center me-3 mb-2 legend-item";
        legend.dataset.key = item.key;
        legend.style.cursor = "pointer";

        legend.innerHTML = `
          <span style="
            width: 16px;
            height: 16px;
            background-color: ${item.color};
            display: inline-block;
            border-radius: 3px;
            margin-right: 8px;
            opacity: 1;
          " class="legend-color"></span>
          <span class="small">${item.label}</span>
        `;

        legend.addEventListener("click", () => {
          if (activeCategories.has(item.key)) {
            activeCategories.delete(item.key);
            legend.querySelector(".legend-color").style.opacity = 0.3;
          } else {
            activeCategories.add(item.key);
            legend.querySelector(".legend-color").style.opacity = 1;
          }

          // Filter chart data
          filteredData = dataWithColors.filter(d => activeCategories.has(d.category));
          chart.updateSeries([{
            name: 'Average Rating (A)',
            data: filteredData
          }]);
        });

        container.appendChild(legend);
      });
    }

    renderLegend();
  });
</script>





<script id="chart-data-mfo" type="application/json">
  {{ chart_data_mfo | tojson | safe }}
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const data = JSON.parse(document.getElementById("chart-data-mfo").textContent);

    const options = {
      series: data.series,
      chart: { type: 'bar', height: 400 },
      plotOptions: {
        bar: {
          horizontal: false,
          columnWidth: '60%',
          borderRadius: 4
        }
      },
      dataLabels: {
        enabled: true,
        formatter: function (val) {
          return val.toFixed(1);
        }
      },
      xaxis: {
        categories: data.categories
      },
      yaxis: {
        min: 1,
        max: 5,
        tickAmount: 4,
        title: { text: 'QETA Rating' }
      },
      colors: ['#1E90FF', '#28a745', '#ffc107', '#6f42c1'],
      tooltip: {
        y: {
          formatter: function (val) {
            return "Rating: " + val.toFixed(2);
          }
        }
      }
    };

    const chart = new ApexCharts(document.querySelector("#ipcr-chart-mfo"), options);
    chart.render();
  });
</script>


{% endblock content %} 